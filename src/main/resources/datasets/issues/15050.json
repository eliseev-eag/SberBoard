{
  "url": "https://api.github.com/repos/facebook/react/issues/15050",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/15050/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/15050/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/15050/events",
  "html_url": "https://github.com/facebook/react/issues/15050",
  "id": 418216849,
  "node_id": "MDU6SXNzdWU0MTgyMTY4NDk=",
  "number": 15050,
  "title": "Hooks error from external component",
  "user": {
    "login": "mrbinr",
    "id": 5592292,
    "node_id": "MDQ6VXNlcjU1OTIyOTI=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/5592292?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mrbinr",
    "html_url": "https://github.com/mrbinr",
    "followers_url": "https://api.github.com/users/mrbinr/followers",
    "following_url": "https://api.github.com/users/mrbinr/following{/other_user}",
    "gists_url": "https://api.github.com/users/mrbinr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mrbinr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mrbinr/subscriptions",
    "organizations_url": "https://api.github.com/users/mrbinr/orgs",
    "repos_url": "https://api.github.com/users/mrbinr/repos",
    "events_url": "https://api.github.com/users/mrbinr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mrbinr/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2019-03-07T09:48:29Z",
  "updated_at": "2019-03-08T09:49:55Z",
  "closed_at": "2019-03-07T12:56:30Z",
  "author_association": "NONE",
  "body": "<!--\r\n  Note: if the issue is about documentation or the website, please file it at:\r\n  https://github.com/reactjs/reactjs.org/issues/new\r\n-->\r\n\r\n**Do you want to request a *feature* or report a *bug*?**\r\nbug\r\n\r\n**What is the current behavior?**\r\nWe are trying to create an external module which will be imported in main app.\r\nHere is the module : \r\n```import React, { useState } from 'react';\r\nexport const MyHelloComponent = (props) => {\r\n  const [test, setTest] = useState();\r\n  return (<div>Hello</div>);\r\n}\r\n```\r\nImporting this simple code into main app gives us the error : \r\n\r\n> Uncaught Invariant Violation: Hooks can only be called inside the body of a function component\r\n\r\nRemoving hooks this code works fine.\r\n\r\nWe have followed instructions from [https://reactjs.org/warnings/invalid-hook-call-warning.html#duplicate-react](https://reactjs.org/warnings/invalid-hook-call-warning.html#duplicate-react) but error still thrown\r\n\r\nIf we link react as mentionned in documentation, works but it only can be done in development not in production.\r\n\r\nWe are not the only one having this issue [Side package with React Hooks failing with Invariant Violation when called in main package](https://stackoverflow.com/questions/54916349/side-package-with-react-hooks-failing-with-invariant-violation-when-called-in)\r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce and if possible a minimal demo of the problem. Your bug will get fixed much faster if we can run your code and it doesn't have dependencies other than React. Paste the link to your JSFiddle (https://jsfiddle.net/Luktwrdm/) or CodeSandbox (https://codesandbox.io/s/new) example below:**\r\n\r\n**Code from external component :** \r\npackage.json\r\n``` \r\n{\r\n  \"name\": \"app-component\",\r\n  \"version\": \"1.0.0\",\r\n  \"main\": \"build/index.js\",\r\n  \"license\": \"MIT\",\r\n  \"private\": true,\r\n  \"peerDependencies\": {\r\n    \"react\": \"^16.8.4\",\r\n    \"react-dom\": \"^16.8.4\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@babel/core\": \"^7.3.4\",\r\n    \"@babel/plugin-proposal-class-properties\": \"^7.3.4\",\r\n    \"@babel/plugin-proposal-object-rest-spread\": \"^7.3.4\",\r\n    \"@babel/plugin-transform-react-jsx\": \"^7.3.0\",\r\n    \"@babel/plugin-transform-regenerator\": \"^7.3.4\",\r\n    \"@babel/preset-env\": \"^7.3.4\",\r\n    \"@babel/preset-react\": \"^7.0.0\",\r\n    \"babel-loader\": \"^8.0.5\",\r\n    \"css-loader\": \"^2.1.0\",\r\n    \"react\": \"^16.8.4\",\r\n    \"react-dom\": \"^16.8.4\",\r\n    \"style-loader\": \"^0.23.1\",\r\n    \"styled-jsx\": \"^3.2.1\",\r\n    \"webpack\": \"^4.29.5\",\r\n    \"webpack-cli\": \"^3.2.3\"\r\n  },\r\n  \"scripts\": {\r\n    \"build\": \"./node_modules/.bin/webpack --mode production\",\r\n    \"dev\": \"./node_modules/.bin/webpack --mode development --watch\"\r\n  },\r\n  \"files\": [\r\n    \"build\"\r\n  ],\r\n  \"dependencies\": {\r\n    \"@material-ui/core\": \"^3.9.2\"\r\n  }\r\n}\r\n ```\r\nwebpack.config.js\r\n\r\n```\r\nconst path = require('path');\r\nconst pkg = require('./package.json');\r\n\r\nconst libraryName= pkg.name;\r\n\r\nmodule.exports = (env, argv) => ({\r\n  entry: './src/index.js',\r\n  output: {\r\n    path: path.resolve(__dirname, 'build'),\r\n    filename: 'index.js',\r\n    library: libraryName,\r\n    libraryTarget: 'commonjs2',\r\n    publicPath: '/build/',\r\n  },\r\n  devtool: argv.mode !== 'production' ? 'inline-source-map': false,\r\n  module: {\r\n    rules: [\r\n      {\r\n        test: /\\.js$/,\r\n        include: path.resolve(__dirname, 'src'),\r\n        exclude: /(node_modules|bower_components)/,\r\n        use: ['babel-loader']\r\n      },\r\n      {\r\n        test: /\\.css$/,\r\n        use: ['style-loader', 'css-loader']\r\n      },\r\n    ]\r\n  },\r\n\r\n  resolve: {\r\n    alias: {\r\n      'react': path.resolve('./node_modules/react'),\r\n      'react-dom': path.resolve('./node_modules/react-dom'),\r\n    }\r\n  },\r\n  externals: {\r\n    react: \"react\",\r\n    \"react-dom\": \"react-dom\"\r\n  }\r\n});\r\n```\r\nsrc/index.js\r\n```\r\nexport * from './components/hello';\r\n```\r\nsrc/components/hello.js\r\n```\r\nimport React, { useState } from 'react';\r\nexport const MyHelloComponent = (props) => {\r\n  const [test, setTest] = useState();\r\n  return (<div>Hello</div>);\r\n}\r\n```\r\n\r\n**Code from main app:** \r\nwebpack.config.js\r\n```\r\nmodule.exports = {\r\n  entry: './src/index.js',\r\n  output: {\r\n    path: __dirname + '/dist',\r\n    publicPath: '/dist/',\r\n    filename: 'bundle.js'\r\n  },\r\n  devServer: {\r\n    contentBase: './public',\r\n  },\r\n  module: {\r\n    rules: [\r\n      {\r\n        test: /\\.(js|jsx)$/,\r\n        exclude: /node_modules/,\r\n        use: ['babel-loader']\r\n      }\r\n    ]\r\n  },\r\n};\r\n```\r\n\r\npackage.json\r\n```\r\n{\r\n  \"name\": \"react-app-shell\",\r\n  \"version\": \"1.0.0\",\r\n  \"main\": \"index.js\",\r\n  \"license\": \"MIT\",\r\n  \"scripts\": {\r\n    \"start\": \"webpack-dev-server --mode development\"\r\n  },\r\n  \"dependencies\": {\r\n    \"react\": \"^16.8.4\",\r\n    \"react-dom\": \"^16.8.4\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@babel/core\": \"^7.3.4\",\r\n    \"@babel/preset-env\": \"^7.3.4\",\r\n    \"@babel/preset-react\": \"^7.0.0\",\r\n    \"babel-loader\": \"^8.0.5\",\r\n    \"webpack\": \"^4.29.6\",\r\n    \"webpack-cli\": \"^3.2.3\",\r\n    \"webpack-dev-server\": \"^3.2.1\"\r\n  }\r\n}\r\n```\r\nsrc/index.js\r\n\r\n```\r\nimport React from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\nimport {MyHelloComponent} from 'app-component';\r\n\r\nclass Welcome extends React.Component {\r\n  render() {\r\n    return <><h1>Main App</h1><MyHelloComponent/></>;\r\n  }\r\n}\r\nReactDOM.render(<Welcome />, document.getElementById(\"root\"));\r\n```\r\n\r\nTo be able to make it works, you have to do `yarn link` after (or before) having built it  from component and `yarn link \"app-component\"` from main app.\r\n\r\n\r\n**What is the expected behavior?**\r\nuse hooks from external components works obviously.\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\nReact 16.8.4 and with previous version it doest not work too\r\n\r\n",
  "closed_by": {
    "login": "gaearon",
    "id": 810438,
    "node_id": "MDQ6VXNlcjgxMDQzOA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/810438?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gaearon",
    "html_url": "https://github.com/gaearon",
    "followers_url": "https://api.github.com/users/gaearon/followers",
    "following_url": "https://api.github.com/users/gaearon/following{/other_user}",
    "gists_url": "https://api.github.com/users/gaearon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gaearon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gaearon/subscriptions",
    "organizations_url": "https://api.github.com/users/gaearon/orgs",
    "repos_url": "https://api.github.com/users/gaearon/repos",
    "events_url": "https://api.github.com/users/gaearon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gaearon/received_events",
    "type": "User",
    "site_admin": false
  }
}
