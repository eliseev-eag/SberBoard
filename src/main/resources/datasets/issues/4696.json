{
  "url": "https://api.github.com/repos/facebook/react/issues/4696",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/4696/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/4696/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/4696/events",
  "html_url": "https://github.com/facebook/react/issues/4696",
  "id": 102735146,
  "node_id": "MDU6SXNzdWUxMDI3MzUxNDY=",
  "number": 4696,
  "title": "Using server rendering: Invariant Violation: ReactMount: Two valid but unequal nodes with the same `data-reactid`",
  "user": {
    "login": "justin808",
    "id": 1118459,
    "node_id": "MDQ6VXNlcjExMTg0NTk=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/1118459?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/justin808",
    "html_url": "https://github.com/justin808",
    "followers_url": "https://api.github.com/users/justin808/followers",
    "following_url": "https://api.github.com/users/justin808/following{/other_user}",
    "gists_url": "https://api.github.com/users/justin808/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/justin808/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/justin808/subscriptions",
    "organizations_url": "https://api.github.com/users/justin808/orgs",
    "repos_url": "https://api.github.com/users/justin808/repos",
    "events_url": "https://api.github.com/users/justin808/events{/privacy}",
    "received_events_url": "https://api.github.com/users/justin808/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2015-08-24T08:20:00Z",
  "updated_at": "2015-08-24T09:59:41Z",
  "closed_at": "2015-08-24T09:37:44Z",
  "author_association": "NONE",
  "body": "I'm building a gem to enable the use of React + Redux + Rails with Webpack and server rendering.\n\nI'm pretty far along, having gotten the gem to work with turbolinks. However, I'm running into an issue with fragment caching. \n\nI created a branch which demonstrates the issue: https://github.com/shakacode/react_rails_server_rendering/tree/caching-failure\n\nNOTE: I verified that caching _without_ Turbolinks works OK. See this branch: https://github.com/shakacode/react_rails_server_rendering/tree/caching-ok-without-turbolinks\n\nAlso, no caching with turbolinks works:\nhttps://github.com/shakacode/react_rails_server_rendering/tree/master\n## The issue can be reproduced by the following:\n1. clone the repo\n2. switch to the branch caching-failure\n3. `cd spec/dummy && bundle && npm i && foreman start`\n4. Visit http://localhost:3000\n5. See server rendering worked. Open up console. See tracing messages.\n6. Click on link \"About\" at top.\n7. Click back on link \"React\" at top.\n8. See error message: \"Invariant Violation: ReactMount: Two valid but unequal nodes with the same `data-reactid\" (Full error below).\n## Notes:\n- Open up spec/dummy/app/views/pages/index.html.erb and remove the\n  cache block around line 16 to see this working without fragment caching.\n- With fragment caching, we're removing the React dom elements from the\n  prior rendering to and reloading from cache.\n- Left in tracing statements so we can see when the rendering is called.\n- It is unlikely that the caching changed the rendering part, which\n  includes both:\n  - Call to add/remove listeners which invoke the client side rendering\n    after the dom elements are placed.\n  - Server generated HTML is shown below, which includes the setup of the JS hooks. This code is inserted into the DOM by turbolinks.\n## Possible Reason\n\nI'm guessing there is some problem with calling React with the same exact code on the second time. It seems some state is maintained. Maybe when the page is being unloaded, I need to tell React about this?\n## Here's what the view helper looks like\n\n``` erb\n<!-- This works if we turn off server side rendering -->\n<!--< % cache @app_props do %>-->\n  <% puts \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\" %>\n  <% puts \"server rendering react component\" %>\n  <% puts \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\" %>\n  <%= react_component(\"App\", @app_props) %>\n<!--< % end %>-->\n```\n## Here's the html:\n\n``` html\n        <script>\n//<![CDATA[\n      window.__appData__ = {\"helloWorldData\":{\"name\":\"Prop from Rails from server rendering!\"}};\n      var renderIfDomNodePresent = function() {\n  var appDOMNode = document.getElementById('App-react-component-0');\n  if (appDOMNode) {\n    console.log(\"ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ\");\n    console.log(\"DID CLIENT SIDE RENDER\");\n    console.log(\"ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ\");\n    var reactComponent = App(__appData__);\n    React.render(reactComponent, appDOMNode);\n  }\n}\n\n            var turbolinksInstalled = typeof(Turbolinks) !== 'undefined';\n      console.log(\"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\");\n      console.log(\"turbolinksInstalled is %O\", turbolinksInstalled);\n      console.log(\"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\");\n      if (!turbolinksInstalled) {\n        console.log(\"WARNING: NO TurboLinks detected in JS, but it's in your Gemfile\");\n        document.addEventListener(\"DOMContentLoaded\", function(event) {\n  console.log(\"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\");\n  console.log(\"DOMContentLoaded event fired\");\n  console.log(\"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\");\n  renderIfDomNodePresent();\n});\n\n      } else {\n        function onPageChange(event) {\n          console.log(\"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\");\n          console.log(\"page:change event fired\");\n          console.log(\"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\");\n          var removePageChangeListener = function() {\n            console.log(\"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\");\n            console.log(\"removed page:change event listener fired\");\n            console.log(\"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\");\n            document.removeEventListener(\"page:change\", onPageChange);\n            document.removeEventListener(\"page:before-unload\", removePageChangeListener);\n            console.log(\"removed both event listeners\");\n          };\n          document.addEventListener(\"page:before-unload\", removePageChangeListener);\n\n          document.addEventListener(\"page:after-remove\", function() {\n            console.log(\"page:after-remove called\")\n          });\n\n          renderIfDomNodePresent();\n        }\n        console.log(\"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\");\n        console.log(\"Add turbolinks handler page:change handler\");\n        console.log(\"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\");\n        document.addEventListener(\"page:change\", onPageChange);\n      }\n\n\n//]]>\n</script>\n      <div id=\"App-react-component-0\"><div data-reactid=\".cwh6q4xzwg\" data-react-checksum=\"1276941928\"><h1 data-reactid=\".cwh6q4xzwg.0\"><span data-reactid=\".cwh6q4xzwg.0.0\">Hello, </span><span data-reactid=\".cwh6q4xzwg.0.1\">Prop from Rails from server rendering!</span><span data-reactid=\".cwh6q4xzwg.0.2\">!</span></h1><p data-reactid=\".cwh6q4xzwg.1\"><span data-reactid=\".cwh6q4xzwg.1.0\">Say hello to: </span><input type=\"text\" value=\"Prop from Rails from server rendering!\" data-reactid=\".cwh6q4xzwg.1.1\"></p></div></div>\n```\n\n![cursor_and_dummy](https://cloud.githubusercontent.com/assets/1118459/9435316/6f36c57c-49e2-11e5-9981-f297681db0cf.png)\n\n```\nUncaught Error: Invariant Violation: ReactMount: Two valid but unequal nodes with the same `data-reactid`: .cwh6q4xzwginvariant @ client.self-7a1dcfd3851d1e743119029e3453caa6110fd4559ba3db66c56cbdb87f97a01c.js?body=1:759getID @ client.self-7a1dcfd3851d1e743119029e3453caa6110fd4559ba3db66c56cbdb87f97a01c.js?body=1:7712getReactRootID @ client.self-7a1dcfd3851d1e743119029e3453caa6110fd4559ba3db66c56cbdb87f97a01c.js?body=1:7693render @ client.self-7a1dcfd3851d1e743119029e3453caa6110fd4559ba3db66c56cbdb87f97a01c.js?body=1:7988wrapper @ client.self-7a1dcfd3851d1e743119029e3453caa6110fd4559ba3db66c56cbdb87f97a01c.js?body=1:3099renderIfDomNodePresent @ VM26889:11onPageChange @ VM26889:47triggerEvent @ turbolinks.self-c37727e9bd6b2735da5c311aa83fead54ed0be6cc8bd9a65309e9c5abe2cbfff.js?body=1:334changePage @ turbolinks.self-c37727e9bd6b2735da5c311aa83fead54ed0be6cc8bd9a65309e9c5abe2cbfff.js?body=1:203xhr.onload @ turbolinks.self-c37727e9bd6b2735da5c311aa83fead54ed0be6cc8bd9a65309e9c5abe2cbfff.js?body=1:107\n```\n",
  "closed_by": {
    "login": "justin808",
    "id": 1118459,
    "node_id": "MDQ6VXNlcjExMTg0NTk=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/1118459?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/justin808",
    "html_url": "https://github.com/justin808",
    "followers_url": "https://api.github.com/users/justin808/followers",
    "following_url": "https://api.github.com/users/justin808/following{/other_user}",
    "gists_url": "https://api.github.com/users/justin808/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/justin808/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/justin808/subscriptions",
    "organizations_url": "https://api.github.com/users/justin808/orgs",
    "repos_url": "https://api.github.com/users/justin808/repos",
    "events_url": "https://api.github.com/users/justin808/events{/privacy}",
    "received_events_url": "https://api.github.com/users/justin808/received_events",
    "type": "User",
    "site_admin": false
  }
}
