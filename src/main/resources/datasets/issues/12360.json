{
  "url": "https://api.github.com/repos/facebook/react/issues/12360",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/12360/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/12360/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/12360/events",
  "html_url": "https://github.com/facebook/react/issues/12360",
  "id": 304624078,
  "node_id": "MDU6SXNzdWUzMDQ2MjQwNzg=",
  "number": 12360,
  "title": "addEventListener not working properly in componentDidUpdate",
  "user": {
    "login": "benwiley4000",
    "id": 13558253,
    "node_id": "MDQ6VXNlcjEzNTU4MjUz",
    "avatar_url": "https://avatars2.githubusercontent.com/u/13558253?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benwiley4000",
    "html_url": "https://github.com/benwiley4000",
    "followers_url": "https://api.github.com/users/benwiley4000/followers",
    "following_url": "https://api.github.com/users/benwiley4000/following{/other_user}",
    "gists_url": "https://api.github.com/users/benwiley4000/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benwiley4000/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benwiley4000/subscriptions",
    "organizations_url": "https://api.github.com/users/benwiley4000/orgs",
    "repos_url": "https://api.github.com/users/benwiley4000/repos",
    "events_url": "https://api.github.com/users/benwiley4000/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benwiley4000/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 127893911,
      "node_id": "MDU6TGFiZWwxMjc4OTM5MTE=",
      "url": "https://api.github.com/repos/facebook/react/labels/Component:%20DOM",
      "name": "Component: DOM",
      "color": "fef2c0",
      "default": false
    },
    {
      "id": 620368407,
      "node_id": "MDU6TGFiZWw2MjAzNjg0MDc=",
      "url": "https://api.github.com/repos/facebook/react/labels/Resolution:%20Needs%20More%20Information",
      "name": "Resolution: Needs More Information",
      "color": "fffde7",
      "default": false
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2018-03-13T04:27:21Z",
  "updated_at": "2019-03-07T12:56:41Z",
  "closed_at": "2018-08-02T19:42:16Z",
  "author_association": "NONE",
  "body": "**Do you want to request a *feature* or report a *bug*?**\r\nBug!\r\n\r\n**What is the current behavior?**\r\nWhen I update event listeners by removing old listeners and adding new ones on an element obtained by React ref in `componentDidUpdate` (React 16.3 alpha), my handlers don't register properly. If I take out the part where I remove listeners, or put the whole thing inside a `setTimeout`, it works fine. **This worked fine when I was doing it in componentWillReceiveProps but I moved this part to componentDidUpdate for React 16.3.**\r\n\r\nMy code is kind of like:\r\n```jsx\r\n// does NOT work\r\ncomponentDidUpdate(prevProps) {\r\n  for (const eventType in prevProps.eventHandlers) {\r\n    this.audio.removeEventListener(eventType, prevProps.eventHandlers[eventType]);\r\n  }\r\n  for (const eventType in this.props.eventHandlers) {\r\n    this.audio.addEventListener(eventType, this.props.eventHandlers[eventType]);\r\n  }\r\n  // ...\r\n}\r\n\r\n// DOES work!\r\ncomponentDidUpdate(prevProps) {\r\n  // for (const eventType in prevProps.eventHandlers) {\r\n  //   this.audio.removeEventListener(eventType, prevProps.eventHandlers[eventType]);\r\n  // }\r\n  for (const eventType in this.props.eventHandlers) {\r\n    this.audio.addEventListener(eventType, this.props.eventHandlers[eventType]);\r\n  }\r\n  // ...\r\n}\r\n\r\n// DOES work!\r\ncomponentDidUpdate(prevProps) {\r\n  setTimeout(() => {\r\n    for (const eventType in prevProps.eventHandlers) {\r\n      this.audio.removeEventListener(eventType, prevProps.eventHandlers[eventType]);\r\n    }\r\n    for (const eventType in this.props.eventHandlers) {\r\n      this.audio.addEventListener(eventType, this.props.eventHandlers[eventType]);\r\n    }\r\n  });\r\n  // ...\r\n}\r\n\r\nrender() {\r\n  return <audio ref={a => this.audio = a} />;\r\n}\r\n```\r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce and if possible a minimal demo of the problem. Your bug will get fixed much faster if we can run your code and it doesn't have dependencies other than React. Paste the link to your JSFiddle (https://jsfiddle.net/Luktwrdm/) or CodeSandbox (https://codesandbox.io/s/new) example below:**\r\n\r\nUnfortunately I can't reproduce in a simple example but you can check out and build the [`next`](https://github.com/benwiley4000/react-responsive-audio-player/tree/7235ba9908bbd493e431d123406fcee063a1eefc) branch of react-responsive-audio-player and run `npm run dev` to see the behavior (example.html adds a listener which should run when volume toggles from muted to unmuted). [`componentDidUpdate`](https://github.com/benwiley4000/react-responsive-audio-player/blob/next/src/AudioPlayer.js#L245) \r\n\r\n**What is the expected behavior?**\r\n\r\nListener adding should work fine\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\nI tested React 16.3-alpha.1. I think the issue also exists in React 15 - I was able to reproduce the problem locally with React 15 but I had to make some manual tweaks to create-react-context to make it backward compatible (I've now [published a polyfill](https://github.com/benwiley4000/react-dot-fragment) to make this sort of thing easier).",
  "closed_by": {
    "login": "gaearon",
    "id": 810438,
    "node_id": "MDQ6VXNlcjgxMDQzOA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/810438?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gaearon",
    "html_url": "https://github.com/gaearon",
    "followers_url": "https://api.github.com/users/gaearon/followers",
    "following_url": "https://api.github.com/users/gaearon/following{/other_user}",
    "gists_url": "https://api.github.com/users/gaearon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gaearon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gaearon/subscriptions",
    "organizations_url": "https://api.github.com/users/gaearon/orgs",
    "repos_url": "https://api.github.com/users/gaearon/repos",
    "events_url": "https://api.github.com/users/gaearon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gaearon/received_events",
    "type": "User",
    "site_admin": false
  }
}
