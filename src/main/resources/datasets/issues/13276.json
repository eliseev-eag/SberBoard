{
  "url": "https://api.github.com/repos/facebook/react/issues/13276",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/13276/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/13276/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/13276/events",
  "html_url": "https://github.com/facebook/react/issues/13276",
  "id": 344986544,
  "node_id": "MDU6SXNzdWUzNDQ5ODY1NDQ=",
  "number": 13276,
  "title": "ReactDOMServer.renderToStaticMarkup() fatals when NODE_ENV is set to production",
  "user": {
    "login": "alpjor",
    "id": 61747,
    "node_id": "MDQ6VXNlcjYxNzQ3",
    "avatar_url": "https://avatars2.githubusercontent.com/u/61747?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alpjor",
    "html_url": "https://github.com/alpjor",
    "followers_url": "https://api.github.com/users/alpjor/followers",
    "following_url": "https://api.github.com/users/alpjor/following{/other_user}",
    "gists_url": "https://api.github.com/users/alpjor/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alpjor/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alpjor/subscriptions",
    "organizations_url": "https://api.github.com/users/alpjor/orgs",
    "repos_url": "https://api.github.com/users/alpjor/repos",
    "events_url": "https://api.github.com/users/alpjor/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alpjor/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-07-26T20:05:13Z",
  "updated_at": "2018-07-26T22:21:13Z",
  "closed_at": "2018-07-26T22:21:13Z",
  "author_association": "NONE",
  "body": "<!--\r\n  Note: if the issue is about documentation or the website, please file it at:\r\n  https://github.com/reactjs/reactjs.org/issues/new\r\n-->\r\n\r\n**Do you want to request a *feature* or report a *bug*?**\r\nReporting a Bug\r\n\r\n**What is the current behavior?**\r\nThe main issue is an exception that get's thrown when I try to call ReactDOMServer.renderToStaticMarkup() when NODE_ENV is set to production\r\n\r\n```\r\n/Users/alpjor/Documents/Code/rende/rende/client/build/staticWriter.js:4818\r\n    ReactDebugCurrentFrame.getCurrentStack = getStackAddendum;\r\n                                           ^\r\n\r\nTypeError: Cannot set property 'getCurrentStack' of undefined\r\n    at setCurrentDebugStack (/Users/alpjor/Documents/Code/rende/rende/client/build/staticWriter.js:4818:44)\r\n    at ReactDOMServerRenderer.read (/Users/alpjor/Documents/Code/rende/rende/client/build/staticWriter.js:5362:9)\r\n    at Object.renderToStaticMarkup (/Users/alpjor/Documents/Code/rende/rende/client/build/staticWriter.js:5747:25)\r\n    at Object../imports/server/staticWriter.js (/Users/alpjor/Documents/Code/rende/rende/client/build/staticWriter.js:2406:108)\r\n    at __webpack_require__ (/Users/alpjor/Documents/Code/rende/rende/client/build/staticWriter.js:20:30)\r\n    at ../rende/config/fe_environment_targets.json.module.exports.local.api.https (/Users/alpjor/Documents/Code/rende/rende/client/build/staticWriter.js:84:18)\r\n    at Object.<anonymous> (/Users/alpjor/Documents/Code/rende/rende/client/build/staticWriter.js:87:10)\r\n    at Module._compile (module.js:649:30)\r\n    at Object.Module._extensions..js (module.js:660:10)\r\n    at Module.load (module.js:561:32)\r\nError: Command failed: node /Users/alpjor/Documents/Code/rende/rende/client/build/staticWriter.js\r\n    at checkExecSyncError (child_process.js:575:11)\r\n    at Object.execFileSync (child_process.js:593:13)\r\n    at /Users/alpjor/Documents/Code/rende/rende/client/webpack.client.config.js:69:21\r\n    at AsyncSeriesHook.eval [as callAsync] (eval at create (/Users/alpjor/Documents/Code/rende/rende/client/node_modules/tapable/lib/HookCodeFactory.js:24:12), <anonymous>:18:1)\r\n    at AsyncSeriesHook.lazyCompileHook [as _callAsync] (/Users/alpjor/Documents/Code/rende/rende/client/node_modules/tapable/lib/Hook.js:35:21)\r\n    at emitRecords.err (/Users/alpjor/Documents/Code/rende/rende/client/node_modules/webpack/lib/Compiler.js:257:22)\r\n    at Compiler.emitRecords (/Users/alpjor/Documents/Code/rende/rende/client/node_modules/webpack/lib/Compiler.js:372:39)\r\n    at emitAssets.err (/Users/alpjor/Documents/Code/rende/rende/client/node_modules/webpack/lib/Compiler.js:251:10)\r\n    at hooks.afterEmit.callAsync.err (/Users/alpjor/Documents/Code/rende/rende/client/node_modules/webpack/lib/Compiler.js:358:14)\r\n    at AsyncSeriesHook.eval [as callAsync] (eval at create (/Users/alpjor/Documents/Code/rende/rende/client/node_modules/tapable/lib/HookCodeFactory.js:24:12), <anonymous>:20:1)\r\n    at AsyncSeriesHook.lazyCompileHook [as _callAsync] (/Users/alpjor/Documents/Code/rende/rende/client/node_modules/tapable/lib/Hook.js:35:21)\r\n    at asyncLib.forEach.err (/Users/alpjor/Documents/Code/rende/rende/client/node_modules/webpack/lib/Compiler.js:355:27)\r\n    at done (/Users/alpjor/Documents/Code/rende/rende/client/node_modules/neo-async/async.js:2854:11)\r\n    at /Users/alpjor/Documents/Code/rende/rende/client/node_modules/neo-async/async.js:2805:7\r\n    at /Users/alpjor/Documents/Code/rende/rende/client/node_modules/graceful-fs/graceful-fs.js:43:10\r\n    at FSReqWrap.oncomplete (fs.js:153:20)\r\n\r\n```\r\n\r\nas long as I change the NODE_ENV to anything other than production things work fine\r\nbut in PROD this happens: https://stackoverflow.com/questions/49154914/reactdom-rss-rendertostring-production-error You can use the repo provided to reproduce the error.\r\n\r\nThe issue seems to stem from ReactDebugCurrentFrame is not defined in production and yet ReactDOMServer tries to access it when NODE_ENV is prod and the error happens\r\n\r\nright now I have to break my ReactDOMServer renders out into it's own script and run it when NODE_ENV is not prod\r\n\r\n```\r\n      // hack so that ReactDOMServer.renderStaticMarkup doesn't thrown when\r\n      // called with NODE_ENV = 'production'\r\n      const new_env = Object.create(process.env);\r\n      if (isProduction) new_env.NODE_ENV = 'dev';\r\n\r\n      // call staticWriter script\r\n      child_process.execFileSync(\r\n        'node',\r\n        [path.join(\r\n          mainPath,\r\n          'build',\r\n          'staticWriter.js'\r\n        )], {\r\n          stdio: 'inherit',\r\n          env: new_env\r\n        }\r\n      );\r\n```\r\n\r\nThe triggering lines from staticWriter.js are here:\r\n\r\n```\r\nfs.writeFileSync(\r\n  path.join(dist, 'index.html'),\r\n  '<!doctype html>\\n' +\r\n  ReactDOMServer.renderToStaticMarkup(\r\n    React.createElement(RendeIndex, {javascript: js, css: css})\r\n  )\r\n);\r\n\r\nfs.writeFileSync(\r\n  path.join(dist, 'manifest.html'),\r\n  '<!doctype html>\\n' +\r\n  ReactDOMServer.renderToStaticMarkup(React.createElement(RendeManifest))\r\n);\r\n```\r\n\r\nYou can see the same issue again here (in Chinese) https://github.com/margox/braft-editor/issues/56\r\n\r\nthis seems to be new in React 16\r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce and if possible a minimal demo of the problem. Your bug will get fixed much faster if we can run your code and it doesn't have dependencies other than React. Paste the link to your JSFiddle (https://jsfiddle.net/Luktwrdm/) or CodeSandbox (https://codesandbox.io/s/new) example below:**\r\n\r\n**What is the expected behavior?**\r\n\r\nI would expect to be able to call ReactDOMServer.renderToStaticMarkup with NODE_ENV = production and have it work to turn react classes into a HTML string document.\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\n\r\nI think this is new in React16.\r\n",
  "closed_by": {
    "login": "alpjor",
    "id": 61747,
    "node_id": "MDQ6VXNlcjYxNzQ3",
    "avatar_url": "https://avatars2.githubusercontent.com/u/61747?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alpjor",
    "html_url": "https://github.com/alpjor",
    "followers_url": "https://api.github.com/users/alpjor/followers",
    "following_url": "https://api.github.com/users/alpjor/following{/other_user}",
    "gists_url": "https://api.github.com/users/alpjor/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alpjor/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alpjor/subscriptions",
    "organizations_url": "https://api.github.com/users/alpjor/orgs",
    "repos_url": "https://api.github.com/users/alpjor/repos",
    "events_url": "https://api.github.com/users/alpjor/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alpjor/received_events",
    "type": "User",
    "site_admin": false
  }
}
