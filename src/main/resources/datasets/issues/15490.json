{
  "url": "https://api.github.com/repos/facebook/react/issues/15490",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/15490/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/15490/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/15490/events",
  "html_url": "https://github.com/facebook/react/pull/15490",
  "id": 436922957,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjczMzEyMDE4",
  "number": 15490,
  "title": "[React Native] Inline calls to FabricUIManager in shared code",
  "user": {
    "login": "TheSavior",
    "id": 249164,
    "node_id": "MDQ6VXNlcjI0OTE2NA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/249164?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/TheSavior",
    "html_url": "https://github.com/TheSavior",
    "followers_url": "https://api.github.com/users/TheSavior/followers",
    "following_url": "https://api.github.com/users/TheSavior/following{/other_user}",
    "gists_url": "https://api.github.com/users/TheSavior/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/TheSavior/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TheSavior/subscriptions",
    "organizations_url": "https://api.github.com/users/TheSavior/orgs",
    "repos_url": "https://api.github.com/users/TheSavior/repos",
    "events_url": "https://api.github.com/users/TheSavior/events{/privacy}",
    "received_events_url": "https://api.github.com/users/TheSavior/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 196858374,
      "node_id": "MDU6TGFiZWwxOTY4NTgzNzQ=",
      "url": "https://api.github.com/repos/facebook/react/labels/CLA%20Signed",
      "name": "CLA Signed",
      "color": "e7e7e7",
      "default": false
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2019-04-24T21:50:29Z",
  "updated_at": "2019-04-29T21:31:23Z",
  "closed_at": "2019-04-29T21:31:17Z",
  "author_association": "MEMBER",
  "pull_request": {
    "url": "https://api.github.com/repos/facebook/react/pulls/15490",
    "html_url": "https://github.com/facebook/react/pull/15490",
    "diff_url": "https://github.com/facebook/react/pull/15490.diff",
    "patch_url": "https://github.com/facebook/react/pull/15490.patch"
  },
  "body": "My previous commit (https://github.com/facebook/react/commit/1b2159acc34d9ca2c950e53bfc46db385a75dbad) caused crashes when running in Fabric when navigating from a paper screen to a fabric screen. \r\n\r\nThe NativeMethodsMixin and ReactNativeComponent code is shared in both the Paper renderer and Fabric renderer. The previous commit caused the top of the paper renderer to include `require('FabricUIManager')`. \r\n\r\n`FabricUIManager.js` is essentially just:\r\n```\r\nmodule.exports = global.nativeFabricUIManager;\r\n```\r\n\r\nBecause this code was getting called at the top of the paper renderer, `FabricUIManager` was exporting `undefined`. \r\n\r\nWhen transitioning to a Fabric screen, c++ installs that global, and then the FabricRenderer has this check:\r\n\r\n```\r\nif (FabricUIManager.registerEventHandler) {\r\n  ...\r\n}\r\n```\r\n\r\nThis manifested as a crash `cannot access registerEventHandle of undefined`. This is because FabricUIManager was cached from being accessed too early. \r\n\r\n## The \"right\" fix\r\nWe will fix this correctly by having native always, on startup, define and set the object:\r\n```\r\nglobal.nativeFabricUIManager = {\r\n  createNode,\r\n  cloneNode,\r\n  measure,\r\n  measureInWindow,\r\n  // ...\r\n} \r\n```\r\n\r\nWhen starting with the paper renderer, these functions will just throw.\r\n\r\nThen, when Fabric is loaded, it will replace the implementation of those functions with the actual correct implementation.\r\n\r\nThis will ensure there is no timing issues with when JavaScript reads and caches the value of the global or any of the functions.\r\n\r\nWe will need to ensure we replace the implementations of the functions and not redefine them because we will need to support JS reading the functions early like this:\r\n\r\n```\r\nconst {createNode, measure} = global.nativeFabricUIManager;\r\n```\r\nReading them early, and then calling them after Fabric has loaded will need to work. \r\n\r\n## The \"short term\" fix\r\n\r\nThis PR includes the short term fix which is to inline these requires so that it isn't called early. Normally this would happen by default as we run everything inline requires however this file is blacklisted from inline requires in React Native as it is faster this way. \r\n\r\n## Test Plan:\r\nOpened Marketplace (this worked before this change)\r\nNavigating from Catalyst (paper) to Fabric RNTester (fabric). This crashed before with the error above and no longer crashes. ",
  "closed_by": {
    "login": "TheSavior",
    "id": 249164,
    "node_id": "MDQ6VXNlcjI0OTE2NA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/249164?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/TheSavior",
    "html_url": "https://github.com/TheSavior",
    "followers_url": "https://api.github.com/users/TheSavior/followers",
    "following_url": "https://api.github.com/users/TheSavior/following{/other_user}",
    "gists_url": "https://api.github.com/users/TheSavior/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/TheSavior/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TheSavior/subscriptions",
    "organizations_url": "https://api.github.com/users/TheSavior/orgs",
    "repos_url": "https://api.github.com/users/TheSavior/repos",
    "events_url": "https://api.github.com/users/TheSavior/events{/privacy}",
    "received_events_url": "https://api.github.com/users/TheSavior/received_events",
    "type": "User",
    "site_admin": false
  }
}
