{
  "url": "https://api.github.com/repos/facebook/react/issues/14708",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/14708/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/14708/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/14708/events",
  "html_url": "https://github.com/facebook/react/issues/14708",
  "id": 403481023,
  "node_id": "MDU6SXNzdWU0MDM0ODEwMjM=",
  "number": 14708,
  "title": "hooks: useContext with useState not updating",
  "user": {
    "login": "leonardodino",
    "id": 8649362,
    "node_id": "MDQ6VXNlcjg2NDkzNjI=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/8649362?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/leonardodino",
    "html_url": "https://github.com/leonardodino",
    "followers_url": "https://api.github.com/users/leonardodino/followers",
    "following_url": "https://api.github.com/users/leonardodino/following{/other_user}",
    "gists_url": "https://api.github.com/users/leonardodino/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/leonardodino/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/leonardodino/subscriptions",
    "organizations_url": "https://api.github.com/users/leonardodino/orgs",
    "repos_url": "https://api.github.com/users/leonardodino/repos",
    "events_url": "https://api.github.com/users/leonardodino/events{/privacy}",
    "received_events_url": "https://api.github.com/users/leonardodino/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 40929155,
      "node_id": "MDU6TGFiZWw0MDkyOTE1NQ==",
      "url": "https://api.github.com/repos/facebook/react/labels/Type:%20Question",
      "name": "Type: Question",
      "color": "cc317c",
      "default": false
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2019-01-26T20:39:04Z",
  "updated_at": "2019-01-27T22:19:24Z",
  "closed_at": "2019-01-27T20:36:53Z",
  "author_association": "NONE",
  "body": "<!--\r\n  Note: if the issue is about documentation or the website, please file it at:\r\n  https://github.com/reactjs/reactjs.org/issues/new\r\n-->\r\n\r\n**Do you want to request a *feature* or report a *bug*?**\r\n\r\nseems it's a **bug**. ðŸ˜• \r\n\r\n**What is the current behavior?**\r\n\r\nNested context provider and `useContext` hooks seems to be conflicting, updates get discarded.\r\n\r\n**What is the expected behavior?**\r\n\r\nWhen connecting to a context, it should update whenever it's `value` changes.\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\n\r\n- **react**: `18.8.0-alpha.1` (also reproduced on `16.7.0-alpha.0`)\r\n- **browser**: `chrome 71`\r\n- **os**: macOS Sierra\r\n\r\n---\r\n\r\n### more details\r\n\r\nWhile working on a cleanup of a localStorage \"connection\",\r\nI tried to mix 2 articles ([`[1]`](https://reactjs.org/docs/hooks-faq.html#how-to-avoid-passing-callbacks-down) & [`[2]`](https://reactjs.org/docs/context.html#updating-context-from-a-nested-component)) from the official react documentation, I've implemented it with hooks, but the value seems not to be passing through.\r\n\r\nI've put up a streamlined demo on [codesandbox `[3]`](https://codesandbox.io/s/0yzjr8vnrv).\r\n\r\nThe actual implementation is only a couple of lines more (parsing it from and stringifying it to JSON).\r\n\r\nWorkarounds that I found:\r\n- If I create a new function on each render around the `setValue` function, it actually works. \r\n  - but this goes against the advice on [`[1]`](https://reactjs.org/docs/hooks-faq.html#how-to-avoid-passing-callbacks-down) about avoiding creating  new values.\r\n- Migrate it to a class and use `componentDidUpdate` instead of `useEffect`.\r\n  - I'm actually using this right now, as it works. Including saving a reference to the function in the state.\r\n\r\n---\r\n\r\nIs there anything that shouldn't work on the code below? the effect gets triggered with the changes,\r\nbut the value doesn't get updated on the components that consume via hook. see repro code [`[3]`](https://codesandbox.io/s/0yzjr8vnrv)\r\n\r\n```javascript\r\nconst createLocalStorage = key => {\r\n    const initialValue = localStorage.getItem(key)\r\n    const ValueContext = createContext(initialValue)\r\n    const SetterContext = createContext(() => {})\r\n\r\n    const useStorage = () => [ValueContext, SetterContext].map(useContext)\r\n\r\n    const Provider = ({children}) => {\r\n        const [value, setValue] = useState(initialValue)\r\n\r\n        useEffect(\r\n            () => {\r\n                console.log('effect', value)\r\n                localStorage.setItem(key, value)\r\n            },\r\n            [value],\r\n        )\r\n\r\n        return (\r\n            <ValueContext.Provider value={value}>\r\n                <SetterContext.Provider value={setValue}>\r\n                    {children}\r\n                </SetterContext.Provider>\r\n            </ValueContext.Provider>\r\n        )\r\n    }\r\n\r\n    return [Provider, useStorage]\r\n}\r\n```\r\n\r\n`[1]`: https://reactjs.org/docs/hooks-faq.html#how-to-avoid-passing-callbacks-down\r\n`[2]`: https://reactjs.org/docs/context.html#updating-context-from-a-nested-component\r\n`[3]`: https://codesandbox.io/s/0yzjr8vnrv\r\n\r\n---\r\n\r\n![hlcecpq](https://user-images.githubusercontent.com/8649362/51789871-bea63f80-2174-11e9-9288-151510494a7e.gif)\r\n",
  "closed_by": {
    "login": "leonardodino",
    "id": 8649362,
    "node_id": "MDQ6VXNlcjg2NDkzNjI=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/8649362?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/leonardodino",
    "html_url": "https://github.com/leonardodino",
    "followers_url": "https://api.github.com/users/leonardodino/followers",
    "following_url": "https://api.github.com/users/leonardodino/following{/other_user}",
    "gists_url": "https://api.github.com/users/leonardodino/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/leonardodino/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/leonardodino/subscriptions",
    "organizations_url": "https://api.github.com/users/leonardodino/orgs",
    "repos_url": "https://api.github.com/users/leonardodino/repos",
    "events_url": "https://api.github.com/users/leonardodino/events{/privacy}",
    "received_events_url": "https://api.github.com/users/leonardodino/received_events",
    "type": "User",
    "site_admin": false
  }
}
