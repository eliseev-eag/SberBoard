{
  "url": "https://api.github.com/repos/facebook/react/issues/14940",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/14940/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/14940/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/14940/events",
  "html_url": "https://github.com/facebook/react/pull/14940",
  "id": 413764077,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjU1NjUxMjA2",
  "number": 14940,
  "title": "Fixed incompatibility between react-debug-tools and useContext()",
  "user": {
    "login": "bvaughn",
    "id": 29597,
    "node_id": "MDQ6VXNlcjI5NTk3",
    "avatar_url": "https://avatars0.githubusercontent.com/u/29597?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bvaughn",
    "html_url": "https://github.com/bvaughn",
    "followers_url": "https://api.github.com/users/bvaughn/followers",
    "following_url": "https://api.github.com/users/bvaughn/following{/other_user}",
    "gists_url": "https://api.github.com/users/bvaughn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bvaughn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bvaughn/subscriptions",
    "organizations_url": "https://api.github.com/users/bvaughn/orgs",
    "repos_url": "https://api.github.com/users/bvaughn/repos",
    "events_url": "https://api.github.com/users/bvaughn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bvaughn/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 196858374,
      "node_id": "MDU6TGFiZWwxOTY4NTgzNzQ=",
      "url": "https://api.github.com/repos/facebook/react/labels/CLA%20Signed",
      "name": "CLA Signed",
      "color": "e7e7e7",
      "default": false
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 15,
  "created_at": "2019-02-24T00:55:05Z",
  "updated_at": "2019-03-20T11:27:20Z",
  "closed_at": "2019-02-26T22:24:53Z",
  "author_association": "CONTRIBUTOR",
  "pull_request": {
    "url": "https://api.github.com/repos/facebook/react/pulls/14940",
    "html_url": "https://github.com/facebook/react/pull/14940",
    "diff_url": "https://github.com/facebook/react/pull/14940.diff",
    "patch_url": "https://github.com/facebook/react/pull/14940.patch"
  },
  "body": "An issue was reported in facebookincubator/redux-react-hook/issues/34 where DevTools caused a runtime error when inspecting a component that used a `useContext` hook. I determined the cause to be due to the fact that [the `useContext` hook inside of `ReactDebugHooks` doesn't call `nextHook()` to advance the list](https://github.com/facebook/react/blob/ba708fa79b3db6481b7886f9fdb6bb776d0c2fb9/packages/react-debug-tools/src/ReactDebugHooks.js#L92-L102), which causes subsequent hooks to be mismatched.\r\n\r\nInitially, I thought the fix would be to simply add that call– _but_ React itself is inconsistent with how it treats `useContext` between development and production builds. This presents a problem for the `react-debug-tools` package– it either breaks in development or production mode.\r\n\r\nI've addressed this by refactoring our hooks ordering checks to use a separate, DEV only list (stored on fibers as `_debugHookTypes`). This way we don't have to rely on a hook being added to the hooks list in order to be validated, and code like `ReactDebugHooks` does not have to worry about inconsistent behavior between DEV and PROD bundles, (and we avoid adding additional overhead to PROD bundles).\r\n\r\nThis changed caught a couple of additional warnings in existing tests. I've beefed out or test coverage in this area as well for going forward.\r\n\r\nA few alternative fixes were considered:\r\n1. Update the `useContext` implementation in React to use `mountContext`/`updateContext` (instead of calling `readContext` directly) so that it's _consistent_ between modes.\r\n   * **Cons**: This adds some small additional overhead in production mode that is otherwise unnecessary (and may not be beneficial to the majority of users). This also does not fix DevTools for the existing 16.8 releases.\r\n1. DevTools disables hooks inspection in production mode.\r\n   * **Cons**: This makes DevTools slightly less useful, but that's already the case in production mode due to minification/mangling.\r\n   * **Pros**: This is a backwards compatible fix (meaning `react-debug-tools` will work with earlier hook releases too).\r\n1. DevTools passes the `buildType` flag to `inspectHooks` (telling it whether React is running in production mode). `ReactDebugHooks.useContext` then conditional calls `nextHook()` based on this flag.\r\n   * **Cons**: This feels a little fragile and the API feels a little awkward (since there's already a third optional param).\r\n   * **Pros**: This is a backwards compatible fix.\r\n",
  "closed_by": {
    "login": "bvaughn",
    "id": 29597,
    "node_id": "MDQ6VXNlcjI5NTk3",
    "avatar_url": "https://avatars0.githubusercontent.com/u/29597?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bvaughn",
    "html_url": "https://github.com/bvaughn",
    "followers_url": "https://api.github.com/users/bvaughn/followers",
    "following_url": "https://api.github.com/users/bvaughn/following{/other_user}",
    "gists_url": "https://api.github.com/users/bvaughn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bvaughn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bvaughn/subscriptions",
    "organizations_url": "https://api.github.com/users/bvaughn/orgs",
    "repos_url": "https://api.github.com/users/bvaughn/repos",
    "events_url": "https://api.github.com/users/bvaughn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bvaughn/received_events",
    "type": "User",
    "site_admin": false
  }
}
