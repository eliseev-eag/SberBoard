{
  "url": "https://api.github.com/repos/facebook/react/issues/16295",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/16295/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/16295/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/16295/events",
  "html_url": "https://github.com/facebook/react/issues/16295",
  "id": 476935801,
  "node_id": "MDU6SXNzdWU0NzY5MzU4MDE=",
  "number": 16295,
  "title": "useReducer dispatch calls reduce twice ",
  "user": {
    "login": "babloo80",
    "id": 3709328,
    "node_id": "MDQ6VXNlcjM3MDkzMjg=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/3709328?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/babloo80",
    "html_url": "https://github.com/babloo80",
    "followers_url": "https://api.github.com/users/babloo80/followers",
    "following_url": "https://api.github.com/users/babloo80/following{/other_user}",
    "gists_url": "https://api.github.com/users/babloo80/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/babloo80/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/babloo80/subscriptions",
    "organizations_url": "https://api.github.com/users/babloo80/orgs",
    "repos_url": "https://api.github.com/users/babloo80/repos",
    "events_url": "https://api.github.com/users/babloo80/events{/privacy}",
    "received_events_url": "https://api.github.com/users/babloo80/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2019-08-05T15:52:33Z",
  "updated_at": "2019-09-25T15:00:21Z",
  "closed_at": "2019-08-15T12:54:54Z",
  "author_association": "NONE",
  "body": "**Do you want to request a *feature* or report a *bug*?**\r\nreport a bug\r\n\r\n**What is the current behavior?**\r\nwhen a `dispatch()` of OOTB `useReducer` is called, some instances calls the `reduce()` twice.\r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce and if possible a minimal demo of the problem. Your bug will get fixed much faster if we can run your code and it doesn't have dependencies other than React. Paste the link to your JSFiddle (https://jsfiddle.net/Luktwrdm/) or CodeSandbox (https://codesandbox.io/s/new) example below:**\r\nAs the behavior is intermittent, I shall try to figure out a way to write a reproducer. But, based on call stacks here is what what I can narrow it down. \r\nAssume,\r\n\r\n```\r\nconst [state, dispatch] = useReducer(reduce, {})\r\n...\r\ndispatch({something_useful...}) //this call happens twice in the execution stack.\r\n```\r\n\r\nSeldom calls to `dispatch()` executes the `reduce()` twice and both the times (it does preserve the previous state. Meaning, it merely calls \r\nT1: (s', a') => s''\r\nT2: (s', a') => s''\r\nNotice, the state starts with s' only and NOT s''. Hence, the resultant state s'' is still safe.\r\n\r\nI do have some call stack that shows the difference from `react-dom`.\r\n\r\nFirst stack-trace when `dispatch()` is called.\r\n```\r\nhttps://github.com/facebook/react/blob/42794557ca44a8c05c71aab698d44d1294236538/packages/react-dom/src/server/ReactPartialRendererHooks.js#L404 -- dispatchAction\r\nwsReducer\t@\tuseWSConnector.js:11 <-- my reduce()\r\ndispatchAction\t@\treact-dom.development.js:14088\r\n(anonymous)\t@\tuseWSConnector.js:73 <-- my custom hook (the exact line to dispatch())\r\n```\r\n\r\nSecond stack-trace that is called implicitly.\r\n```\r\nhttps://github.com/facebook/react/blob/42794557ca44a8c05c71aab698d44d1294236538/packages/react-reconciler/src/ReactFiberHooks.js#L658 -- updateReducer\r\nwsReducer\t@\tuseWSConnector.js:11 <-- my reduce()\r\nupdateReducer\t@\treact-dom.development.js:13741\r\nuseReducer\t@\treact-dom.development.js:14349\r\nuseReducer\t@\treact.development.js:1500\r\nuseWS\t@\tuseWSConnector.js:41  <-- my custom hook (the stack to the start of my custom hook)\r\n```\r\n\r\nAs, I am not familiar with `react-dom` source code, some hints around what may be happening in both the call-stacks may help.\r\n\r\n**What is the expected behavior?**\r\nwhen a `dispatch()` of OOTB `useReducer` is called, all instances should call the `reduce()` only once.\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\nReact 16.8.6, Chrome 75.0.3770.142 (Official Build) (64-bit)",
  "closed_by": {
    "login": "gaearon",
    "id": 810438,
    "node_id": "MDQ6VXNlcjgxMDQzOA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/810438?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gaearon",
    "html_url": "https://github.com/gaearon",
    "followers_url": "https://api.github.com/users/gaearon/followers",
    "following_url": "https://api.github.com/users/gaearon/following{/other_user}",
    "gists_url": "https://api.github.com/users/gaearon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gaearon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gaearon/subscriptions",
    "organizations_url": "https://api.github.com/users/gaearon/orgs",
    "repos_url": "https://api.github.com/users/gaearon/repos",
    "events_url": "https://api.github.com/users/gaearon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gaearon/received_events",
    "type": "User",
    "site_admin": false
  }
}
