{
  "url": "https://api.github.com/repos/facebook/react/issues/4873",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/4873/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/4873/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/4873/events",
  "html_url": "https://github.com/facebook/react/issues/4873",
  "id": 106456423,
  "node_id": "MDU6SXNzdWUxMDY0NTY0MjM=",
  "number": 4873,
  "title": "SetState fails in callback (via ComponentWillMount), on server only",
  "user": {
    "login": "cachvico",
    "id": 1093972,
    "node_id": "MDQ6VXNlcjEwOTM5NzI=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/1093972?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cachvico",
    "html_url": "https://github.com/cachvico",
    "followers_url": "https://api.github.com/users/cachvico/followers",
    "following_url": "https://api.github.com/users/cachvico/following{/other_user}",
    "gists_url": "https://api.github.com/users/cachvico/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cachvico/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cachvico/subscriptions",
    "organizations_url": "https://api.github.com/users/cachvico/orgs",
    "repos_url": "https://api.github.com/users/cachvico/repos",
    "events_url": "https://api.github.com/users/cachvico/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cachvico/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2015-09-15T01:06:18Z",
  "updated_at": "2015-09-21T21:49:45Z",
  "closed_at": "2015-09-18T20:50:55Z",
  "author_association": "NONE",
  "body": "I need to render React components on the server for SEO. My component fetches data in `ComponentWillMount`, based on the query parameters - but on the server (Node 4.0.0), `SetState` fails in the request's callback. The error can be reproduced with a simpler `setTimeout` too, as in the code example below.\n\nI have found numerous discussion on the web relating to complications between React and server-side rendering. I'm working on two work-around approaches:\n- removing all ajax requests from the server, instead rendering the result of the request directly into a global variable embedded in the first-serve HTML\n- moving the ajax request prior to initialization of the React components, on the server only (the request would still have to live in `ComponentWillMount` (or `ComponentDidMount`) for the client version.\n\nPlease let me know if there is an alternative or recommended approach instead.\n\nn.b. the reason I chose React over say Angular is because of `renderToString` is to ensure search engines can index the page, so this is all a bit of a bother for me right now...\n\n```\nvar React = require('react');\n\n// Reproduced in React 0.13.3 and 0.14.0-beta1\nvar ReactDOMServer = require(\"react-dom/server\");\n\nvar A = React.createClass({\n    componentWillMount: function() {\n        var _this = this;\n        // for example an ajax call to fetch data based on request parameters:\n        setTimeout(function(err, res) {\n            // state is set based on results\n            _this.setState({ a: 1 });\n        }, 100);\n    },\n    render: function() {\n        return React.createElement('div', null);\n    }\n});\n\n\nReactDOMServer.renderToString(React.createElement(A, null));\n```\n\n```\n$ node index.js \n/app/node_modules/react/lib/getActiveElement.js:25\n    return document.body;\n           ^\n\nReferenceError: document is not defined\n    at getActiveElement (/app/node_modules/react/lib/getActiveElement.js:25:12)\n    at ReactReconcileTransaction.ReactInputSelection.getSelectionInformation (/app/node_modules/react/lib/ReactInputSelection.js:38:23)\n    at ReactReconcileTransaction.Mixin.initializeAll (/app/node_modules/react/lib/Transaction.js:168:75)\n    at ReactReconcileTransaction.Mixin.perform (/app/node_modules/react/lib/Transaction.js:135:12)\n    at ReactUpdatesFlushTransaction.Mixin.perform (/app/node_modules/react/lib/Transaction.js:136:20)\n    at ReactUpdatesFlushTransaction.assign.perform (/app/node_modules/react/lib/ReactUpdates.js:86:38)\n    at Object.flushBatchedUpdates (/app/node_modules/react/lib/ReactUpdates.js:147:19)\n    at Object.wrapper [as flushBatchedUpdates] (/app/node_modules/react/lib/ReactPerf.js:66:21)\n    at ReactDefaultBatchingStrategyTransaction.Mixin.closeAll (/app/node_modules/react/lib/Transaction.js:202:25)\n    at ReactDefaultBatchingStrategyTransaction.Mixin.perform (/app/node_modules/react/lib/Transaction.js:149:16)\n```\n",
  "closed_by": {
    "login": "jimfb",
    "id": 9595985,
    "node_id": "MDQ6VXNlcjk1OTU5ODU=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/9595985?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jimfb",
    "html_url": "https://github.com/jimfb",
    "followers_url": "https://api.github.com/users/jimfb/followers",
    "following_url": "https://api.github.com/users/jimfb/following{/other_user}",
    "gists_url": "https://api.github.com/users/jimfb/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jimfb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jimfb/subscriptions",
    "organizations_url": "https://api.github.com/users/jimfb/orgs",
    "repos_url": "https://api.github.com/users/jimfb/repos",
    "events_url": "https://api.github.com/users/jimfb/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jimfb/received_events",
    "type": "User",
    "site_admin": false
  }
}
