{
  "url": "https://api.github.com/repos/facebook/react/issues/7128",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/7128/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/7128/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/7128/events",
  "html_url": "https://github.com/facebook/react/issues/7128",
  "id": 162441650,
  "node_id": "MDU6SXNzdWUxNjI0NDE2NTA=",
  "number": 7128,
  "title": "Clean up top-level event listeners after unmounting all roots",
  "user": {
    "login": "mP1",
    "id": 726970,
    "node_id": "MDQ6VXNlcjcyNjk3MA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/726970?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mP1",
    "html_url": "https://github.com/mP1",
    "followers_url": "https://api.github.com/users/mP1/followers",
    "following_url": "https://api.github.com/users/mP1/following{/other_user}",
    "gists_url": "https://api.github.com/users/mP1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mP1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mP1/subscriptions",
    "organizations_url": "https://api.github.com/users/mP1/orgs",
    "repos_url": "https://api.github.com/users/mP1/repos",
    "events_url": "https://api.github.com/users/mP1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mP1/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 127893911,
      "node_id": "MDU6TGFiZWwxMjc4OTM5MTE=",
      "url": "https://api.github.com/repos/facebook/react/labels/Component:%20DOM",
      "name": "Component: DOM",
      "color": "fef2c0",
      "default": false
    },
    {
      "id": 121709921,
      "node_id": "MDU6TGFiZWwxMjE3MDk5MjE=",
      "url": "https://api.github.com/repos/facebook/react/labels/Type:%20Feature%20Request",
      "name": "Type: Feature Request",
      "color": "c7def8",
      "default": false
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2016-06-27T12:36:08Z",
  "updated_at": "2019-07-17T00:12:36Z",
  "closed_at": "2018-01-02T14:30:10Z",
  "author_association": "NONE",
  "body": "**Do you want to request a _feature_ or report a _bug_?**\nBug - maybe intended behaviour.\n\n**What is the current behavior?**\n\n_Background_\nI have an app that needs to be embedded by other apps (other customers). The idea being \"our\" react app has its javascript loaded in an iframe, but the \"main\" window hosts dom elements from the customers and our react app. That bit works fine. As time goes on \"our\" react UI is no longer needed, and then react root is removed, and the iframe destroyed. These apps are often long lived so there will be times when the react app needs to appear again, and the iframe is recreated and everything reloaded. This can and will happen many times.\n\n_Goal_\nWe would like to NOT keep the iframe around when its not actually needed, but rather re-create just in time when it is needed. This app is used by customers and they would like to embed our \"react\" app, without interference with their \"app\" and all its javascript, which is why we are doing the iframe thing.\n\n_Problem_\nIt is evident by watching the chrome dev tools \"timeline\" memory graph that memory always increases each time a new iframe is created and the react UI is init'd. Unmounting and destroying the iframe, never causes the memory to drop to \"near\" original before load value. Repeating this process multiple times slowly show an increase memory.\n\nThis also causes a more immediate problem, in that react is throwing exceptions on every event (click, type etc) because the window of the iframe is now null.\n\n_Proof: First symptom - Event exceptions (only happens in my app)_\nThese exceptions only happen in my (cant share) app, i cant repo them, but parts of this apply to all react apps. Please read thru - it will all make sense when you get to the end and if you examine my poc.\n\nDestroying the Iframe, leaves React and its event dispatching system in memory. I have a  mixture of x-tag, webcomponents which are used to \"create\" the iframe and load the react app. After the custom element is used (lets call it <EMBED-REACT>), the console starts showing exceptions all within react code. This is a side effect of the react dispatchEvent still being active and trying to do stuff.\n\n``` javascript\nUncaught TypeError: Cannot read property 'nodeName' of null\nshouldUseChangeEvent @ VM1068_embeddedApp.js:14296\nextractEvents @ VM1068_embeddedApp.js:14536\nextractEvents @ VM1068_embeddedApp.js:13000\nhandleTopLevel @ VM1068_embeddedApp.js:19816\nhandleTopLevelImpl @ VM1068_embeddedApp.js:23870\nperform @ VM1068_embeddedApp.js:15510\nbatchedUpdates @ VM1068_embeddedApp.js:23787\nbatchedUpdates @ VM1068_embeddedApp.js:14673\ndispatchEvent @ VM1068_embeddedApp.js:23946\n```\n\nI know about `ReactEventListener.dispatchEvent`(snip below) where i can disable react( i havent actually tried) to avoid the exceptions, but that would leave the memory leak.\n\nhttps://github.com/facebook/react/blob/master/src/renderers/dom/client/ReactEventListener.js#158\n\n``` javascript\n dispatchEvent: function(topLevelType, nativeEvent) {\n    if (!ReactEventListener._enabled) {\n      return;\n    }\n```\n\nIts rather easy to prove that react remains in memory, simply goto the compiled app, find the `React dispatchEvent` and insert a console.log and watch as it continues to \"print\" stuff after unmounting the last component, even though there are no listeners. In my case the exception is caused because all `extractEvents` eventually default to \"window\" as the \"target\".\n\nThere are multiple copies of the same basic idea in various react functions, where it tries to get a target that it assumes will never be null. If one doesnt load react in an iframe, then window is always defined.\n\n``` javascript\nvar targetNode = targetInst ?\n      ReactDOMComponentTree.getNodeFromInstance(targetInst) : window;\n```\n\nLater the `shouldUseChangeEvent` tries to read the nodeName of the now \"undefined\" window, because its iframe has been destroyed, but that now results in an exception (null pointer etc).\n\nhttps://github.com/facebook/react/blob/045f1a791c6e17253e9d927ffca70ae5d00b4fe5/src/renderers/dom/client/eventPlugins/ChangeEventPlugin.js#L72 ...\n\n``` javascript\nfunction shouldUseChangeEvent(elem) {\n  var nodeName = elem.nodeName && elem.nodeName.toLowerCase();\n  return nodeName === 'select' || nodeName === 'input' && elem.type === 'file';\n}\n```\n\n**If the current behavior is a bug, please provide the steps to reproduce and if possible a minimal demo of the problem via https://jsfiddle.net or similar (template: https://jsfiddle.net/reactjs/69z2wepo/).**\n\n**What is the expected behavior?**\nThere are probably two possible solutions, that work in tandem.\n\n1) Firstly React should provide an API that will remove all its global event listeners. Naturally it could complain if there are any active components that remain mounted. This API may be internal/private (not public), if #2 was implemented. It might be called something like `React.shutdownAll` Because everything is gone, the next React render would setup all its globals again.\n\n2) React should dispose of all its global event handlers when the last or \"root\" component is unmounted. This would call the _new api_ mentioned in 1. \n\nEither option solves my problem, where i wish to either let react shutdown gracefully. With this in mind i could.\n- unmount iframe powered react ui component.\n- call React.disposeGlobals (mentioned above). If unmounting auto calls an internal `React.shutdownAll` then this step is skipped.\n- destroy iframe.\n\n_Proof #2_\nGoto your compiled out, locate the `dispatchEvent` and add a console.log, notice even after the last / root container is unmounted stuff will continue to be printed because the event listeners are still active.\n\nI did a very quick scan of the abstraction around adding listeners, and i couldnt see the remove function being stored and then called to cleanup.\n\n_Proof #3_\nLook at my last section below where i have a proof of concept form of the popular todomvc react example.\n\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\nReact 15.0.2\nReact-Dom 15.0.2\nReact-redux 4.4.5 (might be useful to know)\n\n**Reproducable use case**\n\nSorry i tried but decided that using the facebook jsfiddle wasnt really a smart thing for the following reasons.\n- the compile the \"jsx\" content means loading babel etc to compile (babel, jsfiddle etc too many moving parts)\n- its \"hard\" to get the \"root component\" that is inserted into the \"output\" box and \n- its even just too \"hard\" to put the jsx compiled output into somewhere for the iframe src= to \"load\".\n\nI have forked the popular todomvc app and added a few minor edits to recreate, reload, render+unmount x100, destroy everything about the app, and try again in a loop separated by a sleep.\n- https://todomvc.com (todomvc main site)\n- https://github.com/tastejs/todomvc (todomvc github)\n- https://github.com/mP1/todomvc/pull/2 (my fork - with comments and snapshots of chrome dev tools timeline memory graph)\n\nHopefully we can trust the todomvc guys are doing the right thing, no dumb memory leaks. If you examine it should be obvious the only thing im adding is support for my horrible create app, run app, render+unmount many times, render, unmount, sleep a bit and then loop again until counter exhausted.\n\nSorry if this is boring but as a convenience i will list the basic instructions to \"run\" the react version of my branch on your local machines...\n1. clone https://github.com/tastejs/todomvc.git\n2. in the root, run \"gulp\", to compile everything.\n3. run something like \"python -m SimpleHTTPServer\"\n   4A. navigate to http://localhost:8000/examples/react/index.html \n   4B. navigate to http://localhost:8000/examples/react/index3.html\n   // /examples/react corresponds to the dist/examples/react directory that gulp built into.\n\nMy poc supports 3 concepts.\n- re-run todomvc over and over again in \"same\" window.\n- create iframe, load todomvc js in the iframe but render to outer window, unmount, destroy iframe, try 20x\n- create custom element, webcontainer creates iframe and load todomvc js in the iframe but render to outer window, unmount, destroy custom element, try 20x\n\nIf you look at my p/r against todomvc you will see many helpful pictures with memory leak graphs from chrome dev tools for each of the 3 described scenarios and some commentary.\n",
  "closed_by": {
    "login": "gaearon",
    "id": 810438,
    "node_id": "MDQ6VXNlcjgxMDQzOA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/810438?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gaearon",
    "html_url": "https://github.com/gaearon",
    "followers_url": "https://api.github.com/users/gaearon/followers",
    "following_url": "https://api.github.com/users/gaearon/following{/other_user}",
    "gists_url": "https://api.github.com/users/gaearon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gaearon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gaearon/subscriptions",
    "organizations_url": "https://api.github.com/users/gaearon/orgs",
    "repos_url": "https://api.github.com/users/gaearon/repos",
    "events_url": "https://api.github.com/users/gaearon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gaearon/received_events",
    "type": "User",
    "site_admin": false
  }
}
