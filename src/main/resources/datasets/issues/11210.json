{
  "url": "https://api.github.com/repos/facebook/react/issues/11210",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/11210/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/11210/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/11210/events",
  "html_url": "https://github.com/facebook/react/pull/11210",
  "id": 265120239,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTQ2MzM3MDUy",
  "number": 11210,
  "title": "[Not for commit] Demonstrate async bug",
  "user": {
    "login": "acdlite",
    "id": 3624098,
    "node_id": "MDQ6VXNlcjM2MjQwOTg=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/3624098?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/acdlite",
    "html_url": "https://github.com/acdlite",
    "followers_url": "https://api.github.com/users/acdlite/followers",
    "following_url": "https://api.github.com/users/acdlite/following{/other_user}",
    "gists_url": "https://api.github.com/users/acdlite/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/acdlite/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/acdlite/subscriptions",
    "organizations_url": "https://api.github.com/users/acdlite/orgs",
    "repos_url": "https://api.github.com/users/acdlite/repos",
    "events_url": "https://api.github.com/users/acdlite/events{/privacy}",
    "received_events_url": "https://api.github.com/users/acdlite/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 196858374,
      "node_id": "MDU6TGFiZWwxOTY4NTgzNzQ=",
      "url": "https://api.github.com/repos/facebook/react/labels/CLA%20Signed",
      "name": "CLA Signed",
      "color": "e7e7e7",
      "default": false
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2017-10-12T23:14:59Z",
  "updated_at": "2017-10-15T20:43:49Z",
  "closed_at": "2017-10-15T20:43:49Z",
  "author_association": "MEMBER",
  "pull_request": {
    "url": "https://api.github.com/repos/facebook/react/pulls/11210",
    "html_url": "https://github.com/facebook/react/pull/11210",
    "diff_url": "https://github.com/facebook/react/pull/11210.diff",
    "patch_url": "https://github.com/facebook/react/pull/11210.patch"
  },
  "body": "During a recent sync to Facebook's internal repo, we encountered a bug introduced by https://github.com/facebook/react/pull/10426 and fixed by https://github.com/facebook/react/pull/11187.\r\n\r\nEven though the bug is fixed in the latest master, we decided to investigate the root cause of the bug to protect against future regressions.\r\n\r\nThanks to some debugging by @trueadm and @gaearon, I think I have a good sense of what caused the bug. I wasn't able to figure out a test case that reproduces the original error in the old commit, but I'm reasonably confident that it's related to how we calculate the expiration time of an incoming update.\r\n\r\nUpdates that occur during the commit phase (`componentDidUpdate`) should receive task priority, so that they are flushed in the next batch.\r\n\r\nUpdates that occur during the render phase (like `componentWillReceiveProps`) should receive the same expiration time as whatever is currently rendering, so that they are flushed in the current batch. If we're rendering sync work, then the update should have sync expiration. It should *not* be downgraded to task. Otherwise, won't be rendered until the next batch, which could lead to an infinite loop of updates.\r\n\r\nIn the commit that introduced this bug, this check is incorrect:\r\n\r\nhttps://github.com/facebook/react/blob/3019210df2b486416ed94d7b9becffaf254e81c4/src/renderers/shared/fiber/ReactFiberScheduler.js#L1544-L1549\r\n\r\nIt should be checking `isCommitting`, not `isPerforming` work, because we don't want to downgrade if we're in the render phase, only the commit phase.\r\n\r\nEven though this is wrong, it didn't manifest as a bug in our units tests because of other code that happened to mask it in most cases.\r\n\r\nhttps://github.com/facebook/react/pull/11187 removed the incidental complexity that was masking the bug. While working on that PR, I discovered the error and corrected that check:\r\n\r\nhttps://github.com/facebook/react/blob/0c5a455ecb33041f973e9770e8d8dc5fccfcf484/src/renderers/shared/fiber/ReactFiberScheduler.js#L1520-L1523\r\n\r\nThis PR demonstrates that if you change that line back from `isCommitting` to `isPerformingWork`, it causes several unit test failures.",
  "closed_by": {
    "login": "acdlite",
    "id": 3624098,
    "node_id": "MDQ6VXNlcjM2MjQwOTg=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/3624098?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/acdlite",
    "html_url": "https://github.com/acdlite",
    "followers_url": "https://api.github.com/users/acdlite/followers",
    "following_url": "https://api.github.com/users/acdlite/following{/other_user}",
    "gists_url": "https://api.github.com/users/acdlite/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/acdlite/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/acdlite/subscriptions",
    "organizations_url": "https://api.github.com/users/acdlite/orgs",
    "repos_url": "https://api.github.com/users/acdlite/repos",
    "events_url": "https://api.github.com/users/acdlite/events{/privacy}",
    "received_events_url": "https://api.github.com/users/acdlite/received_events",
    "type": "User",
    "site_admin": false
  }
}
