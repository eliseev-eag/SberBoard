{
  "url": "https://api.github.com/repos/facebook/react/issues/15041",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/15041/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/15041/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/15041/events",
  "html_url": "https://github.com/facebook/react/issues/15041",
  "id": 417980041,
  "node_id": "MDU6SXNzdWU0MTc5ODAwNDE=",
  "number": 15041,
  "title": "React Hooks useState updating an array",
  "user": {
    "login": "brettshollenberger",
    "id": 4041410,
    "node_id": "MDQ6VXNlcjQwNDE0MTA=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/4041410?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brettshollenberger",
    "html_url": "https://github.com/brettshollenberger",
    "followers_url": "https://api.github.com/users/brettshollenberger/followers",
    "following_url": "https://api.github.com/users/brettshollenberger/following{/other_user}",
    "gists_url": "https://api.github.com/users/brettshollenberger/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brettshollenberger/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brettshollenberger/subscriptions",
    "organizations_url": "https://api.github.com/users/brettshollenberger/orgs",
    "repos_url": "https://api.github.com/users/brettshollenberger/repos",
    "events_url": "https://api.github.com/users/brettshollenberger/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brettshollenberger/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 40929155,
      "node_id": "MDU6TGFiZWw0MDkyOTE1NQ==",
      "url": "https://api.github.com/repos/facebook/react/labels/Type:%20Question",
      "name": "Type: Question",
      "color": "cc317c",
      "default": false
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2019-03-06T19:51:42Z",
  "updated_at": "2019-08-14T13:34:11Z",
  "closed_at": "2019-03-06T22:51:39Z",
  "author_association": "NONE",
  "body": "<!--\r\n  Note: if the issue is about documentation or the website, please file it at:\r\n  https://github.com/reactjs/reactjs.org/issues/new\r\n-->\r\n\r\n**Do you want to request a *feature* or report a *bug*?**\r\nHooks Clarification\r\n\r\n**What is the current behavior?**\r\nI'm trying to understand the lifecycle of `useState`.\r\n\r\nI have a mock application using a mock websocket. Every second, it sends a new message from the backend. The new message is meant to be appended to an array using `useState`. \r\n\r\nHere are a few different examples that highlight my confusion:\r\n\r\n**Example 1**\r\n[In this example](https://codesandbox.io/s/zz2lj8knyp), if I set the websocket's `onmessage` function once in `useEffect`, then whenever I call `setMessages` to update the `messages` array, the `messages` array I receive as an input is empty.\r\n\r\n```js\r\nconst [messages, setMessages] = useState([]);\r\n\r\nfunction receiveMsg(msg) {\r\n  setMessages(messages.concat(JSON.parse(msg.data)));\r\n}\r\n\r\nuseEffect(function() {\r\n    if (_.isUndefined(socket)) {\r\n      let ws = new MockWebsocket(\"ws://127.0.0.1:8080/\");\r\n      ws.onmessage = receiveMsg;\r\n    }\r\n});\r\n```\r\n\r\nThe effect of this is that I only ever get the latest message in my array.\r\n\r\n**Example 2**\r\nIf, however, I set the `onmessage` function on every render [as in this example](https://codesandbox.io/s/73kr25mkrj), then I get my full array with data appended as I would expect.\r\n\r\n```js\r\nconst [messages, setMessages] = useState([]);\r\n\r\nfunction receiveMsg(msg) {\r\n  setMessages(messages.concat(JSON.parse(msg.data)));\r\n}\r\n\r\nif (!_.isUndefined(socket)) {\r\n  socket.onmessage = receiveMsg;\r\n}\r\n\r\nuseEffect(function() {\r\n  if (_.isUndefined(socket)) {\r\n    let ws = new MockWebsocket(\"ws://127.0.0.1:8080/\");\r\n    ws.onmessage = receiveMsg;\r\n  }\r\n});\r\n```\r\n\r\nIn the `receiveMessage` function, my `messages` array is the whole array instead of an empty one in this example.\r\n\r\n**Example 3**\r\nBUT, if I assign a new reference to `messages`, [as in this example](https://codesandbox.io/s/j1n0py5zz3), and re-assign the value inside `receiveMsg`, then I don't have to re-assign the `onmessage` function over and over.\r\n\r\n```js\r\nconst [messages, setMessages] = useState([]);\r\nlet msgRef = messages;\r\n\r\nfunction receiveMsg(msg) {\r\n  msgRef = msgRef.concat(JSON.parse(msg.data));\r\n  setMessages(msgRef);\r\n}\r\n\r\nuseEffect(function() {\r\n  if (_.isUndefined(socket)) {\r\n    let ws = new MockWebsocket(\"ws://127.0.0.1:8080/\");\r\n    ws.onmessage = receiveMsg;\r\n  }\r\n});\r\n```\r\n\r\n**Example 4**\r\nBut, if I assign a new reference and don't re-assign to it, [as in this example](https://codesandbox.io/s/8pkwr86p29), I continue ending up with an empty array. This suggests it's the assignment back to `msgRef` that is keeping the entire array within the closure.\r\n\r\n```js\r\nconst [messages, setMessages] = useState([]);\r\nlet msgRef = messages;\r\n\r\nfunction receiveMsg(msg) {\r\n  setMessages(msgRef.concat(JSON.parse(msg.data)));\r\n}\r\n```\r\n\r\n**What is the expected behavior?**\r\nMy original expectation was that example #1 would work. I can tell there's something I'm not totally understanding about the way the assignment of variables to closure works with this hook, but I'm struggling to define what exactly's going on. Can someone shed some light on why this works this way?\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\n\r\nReact 16.8",
  "closed_by": {
    "login": "gaearon",
    "id": 810438,
    "node_id": "MDQ6VXNlcjgxMDQzOA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/810438?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gaearon",
    "html_url": "https://github.com/gaearon",
    "followers_url": "https://api.github.com/users/gaearon/followers",
    "following_url": "https://api.github.com/users/gaearon/following{/other_user}",
    "gists_url": "https://api.github.com/users/gaearon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gaearon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gaearon/subscriptions",
    "organizations_url": "https://api.github.com/users/gaearon/orgs",
    "repos_url": "https://api.github.com/users/gaearon/repos",
    "events_url": "https://api.github.com/users/gaearon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gaearon/received_events",
    "type": "User",
    "site_admin": false
  }
}
