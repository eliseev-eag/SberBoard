{
  "url": "https://api.github.com/repos/facebook/react/issues/13920",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/13920/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/13920/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/13920/events",
  "html_url": "https://github.com/facebook/react/issues/13920",
  "id": 372753704,
  "node_id": "MDU6SXNzdWUzNzI3NTM3MDQ=",
  "number": 13920,
  "title": "sCU doesn't prevent child rerender when legacy context and batched setStates are involved",
  "user": {
    "login": "errendir",
    "id": 2817891,
    "node_id": "MDQ6VXNlcjI4MTc4OTE=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/2817891?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/errendir",
    "html_url": "https://github.com/errendir",
    "followers_url": "https://api.github.com/users/errendir/followers",
    "following_url": "https://api.github.com/users/errendir/following{/other_user}",
    "gists_url": "https://api.github.com/users/errendir/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/errendir/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/errendir/subscriptions",
    "organizations_url": "https://api.github.com/users/errendir/orgs",
    "repos_url": "https://api.github.com/users/errendir/repos",
    "events_url": "https://api.github.com/users/errendir/events{/privacy}",
    "received_events_url": "https://api.github.com/users/errendir/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-10-23T00:31:34Z",
  "updated_at": "2018-10-23T17:02:09Z",
  "closed_at": "2018-10-23T17:02:09Z",
  "author_association": "NONE",
  "body": "**Do you want to request a *feature* or report a *bug*?**\r\nThis is a bug report. I think this bug and one already reported (https://github.com/facebook/react/issues/13856) have the same root cause.\r\n\r\n**What is the current behavior?**\r\nA component instance preventing its own rerender, by returning `false` from `shouldComponentUpdate` may under certain condition still get its children rerendered, even if no direct update to said children happened.\r\n\r\nThis behaviour is triggered by a very specific stack of components. The simplest example I managed to create (https://codesandbox.io/s/9zymvq479r) involves five components, each rendering the next one:\r\n- `UpdatingRoot` responsible for triggering the top-level update, by calling `setState` in the `componentDidMount` lifecycle method.\r\n- `LegacyContextInjector` responsible for creating the child context object according to the legacy context API.\r\n- `SCUBarrier` with `shouldComponentUpdate` function always returning `false`. Any children of this component instance should not be rerendered as long as they themselves are not sheduled for an update. This is the behaviour I expect. This bug prevents it from happening.\r\n- `IntermediateComponent` responsible for rendering `UpdatingChild` few levels down in the component instance tree.\r\n-  `UpdatingChild` responsible for calling its own `setState` in the `componentDidMount` lifecycle method.\r\n\r\nEach of the created component instances will be rendered only one or two times. Both `UpdatingRoot` and `UpdatingChild` are expected to be rendered twice, and this does happen. Each of the `IntermediateComponent` instances is expected to render only once. This expectation is based on the fact that the `SCUBarrier#shouldComponentUpdate` always returns false, and no child `IntermediateComponent` instance updates itself. The legacy context API should not pierce through `shouldComponentUpdate` returning `false` (https://reactjs.org/docs/legacy-context.html#updating-context).\r\n\r\nDespite those expectation, all `IntermediateComponent` instances are rendered twice.\r\n\r\nIt's important that the `UpdatingRoot#setState` and `UpdatingChild#setState` function are batched together. You can try \"unbatching\" them, by swapping:\r\n```js\r\nthis.setState({ weAreHome: \"my friend\" });\r\n```\r\nfor\r\n```js\r\nsetTimeout(() => this.setState({ weAreHome: \"my friend\" }),0)\r\n```\r\n\r\nWhen this is done the `IntermediateComponent` instances are correctly rendered only once.\r\n\r\nMy example code does the batching by calling `UpdatingRoot#setState` and `UpdatingChild#setState` functions directly in the `componentDidMount` lifecycles of their respective components. I believe this generally is an anti-pattern, but this approach was chosen for simplicity. The same issue can be replicated by calling both `setState` in `ReactDOM.unstable_batchedUpdates(() => { ... })`\r\n\r\nFor a more practical example of a situation in which two ancestor-descendant components may naturally schedule updates in a batch, take a look at https://github.com/tappleby/redux-batched-subscribe.\r\n\r\nLegacy context API is used by popular components like `Transition` from https://github.com/reactjs/react-transition-group or by commonly used `react-redux`.\r\n\r\nA real-life example of this bug could be:\r\nTwo Redux-connected component `A` and `C` are scheduled for update in the same batch. A `Transition` (from `react-transition-group`) injecting legacy context is rendered between them. Some component `B` in between `A` and `C` (descendent of `A`, ancestor of `C`) implements `shouldComponentUpdate` to optimize the rendering of some unchanging subtree (which eventually, down the line, renders `B`). Both `A` and `C` component instances rerender correctly (as expected, since `react-redux` uses legacy context API correctly as described in https://medium.com/@mweststrate/how-to-safely-use-react-context-b7e343eff076). However the instances corresponding to the unchanging element tree returned by `B` will also be unexpectedly rerendered.\r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce and if possible a minimal demo of the problem.**\r\nhttps://codesandbox.io/s/9zymvq479r\r\n\r\n**What is the expected behavior?**\r\nAll `IntermediateComponent` instances should be rendered only once.\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\nreact \"16.6.0-alpha.f47a958\"\r\nreact-dom \"16.6.0-alpha.8af6728 - canary\"\r\n\r\nI originally discovered this issue in the React/ReactDOM version 16.5.2\r\n\r\nPlease let me know if there is something unclear about this bug. It's definitely not an easy thing to reproduce, since so many different components need to be involved!\r\n",
  "closed_by": {
    "login": "aweary",
    "id": 6886061,
    "node_id": "MDQ6VXNlcjY4ODYwNjE=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/6886061?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/aweary",
    "html_url": "https://github.com/aweary",
    "followers_url": "https://api.github.com/users/aweary/followers",
    "following_url": "https://api.github.com/users/aweary/following{/other_user}",
    "gists_url": "https://api.github.com/users/aweary/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/aweary/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aweary/subscriptions",
    "organizations_url": "https://api.github.com/users/aweary/orgs",
    "repos_url": "https://api.github.com/users/aweary/repos",
    "events_url": "https://api.github.com/users/aweary/events{/privacy}",
    "received_events_url": "https://api.github.com/users/aweary/received_events",
    "type": "User",
    "site_admin": false
  }
}
