{
  "url": "https://api.github.com/repos/facebook/react/issues/13027",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/13027/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/13027/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/13027/events",
  "html_url": "https://github.com/facebook/react/issues/13027",
  "id": 331650307,
  "node_id": "MDU6SXNzdWUzMzE2NTAzMDc=",
  "number": 13027,
  "title": "Shallow renderer is not handling getDerivedStateFromProps properly",
  "user": {
    "login": "fatfisz",
    "id": 6004414,
    "node_id": "MDQ6VXNlcjYwMDQ0MTQ=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/6004414?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fatfisz",
    "html_url": "https://github.com/fatfisz",
    "followers_url": "https://api.github.com/users/fatfisz/followers",
    "following_url": "https://api.github.com/users/fatfisz/following{/other_user}",
    "gists_url": "https://api.github.com/users/fatfisz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fatfisz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fatfisz/subscriptions",
    "organizations_url": "https://api.github.com/users/fatfisz/orgs",
    "repos_url": "https://api.github.com/users/fatfisz/repos",
    "events_url": "https://api.github.com/users/fatfisz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fatfisz/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-06-12T15:54:07Z",
  "updated_at": "2018-06-12T22:36:51Z",
  "closed_at": "2018-06-12T22:36:51Z",
  "author_association": "CONTRIBUTOR",
  "body": "<!--\r\n  Note: if the issue is about documentation or the website, please file it at:\r\n  https://github.com/reactjs/reactjs.org/issues/new\r\n-->\r\n\r\n**Do you want to request a *feature* or report a *bug*?**\r\n\r\nBug\r\n\r\n**What is the current behavior?**\r\n\r\nAfter using enzyme's `setState`, `getDerivedStateFromProps` is called with an older version of state.\r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce and if possible a minimal demo of the problem. Your bug will get fixed much faster if we can run your code and it doesn't have dependencies other than React. Paste the link to your JSFiddle (https://jsfiddle.net/Luktwrdm/) or CodeSandbox (https://codesandbox.io/s/new) example below:**\r\n\r\n```jsx\r\nimport { shallow } from 'enzyme';\r\n\r\nclass Demo extends Component {\r\n  static getDerivedStateFromProps(props, state) {\r\n    return { value: state.value };\r\n  };\r\n\r\n  state = { value: 'old' };\r\n\r\n  render() {\r\n    return <div />;\r\n  }\r\n}\r\n\r\nconst wrapper = shallow(<Demo />);\r\nwrapper.setState({ value: 'new' });\r\nassert(wrapper.state().value === 'new'); // this throws\r\n```\r\n\r\nWhile I don't have a standalone demo, I tracked the problem to the `_updateStateFromStaticLifecycle` method of `ReactShallowRenderer`. Inside of it `getDerivedStateFromProps` is called with `this._instance.state`, but it should be called with `this._newState`. This might be related to the change in when `getDerivedStateFromProps` is being called.\r\n\r\n**What is the expected behavior?**\r\n\r\n```jsx\r\nassert(wrapper.state().value === 'new'); // this doesn't throw\r\n```\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\n\r\nreact-test-renderer@16.4.0\r\nenzyme-adapter-react-16@1.1.1\r\nenzyme@3.3.0",
  "closed_by": {
    "login": "gaearon",
    "id": 810438,
    "node_id": "MDQ6VXNlcjgxMDQzOA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/810438?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gaearon",
    "html_url": "https://github.com/gaearon",
    "followers_url": "https://api.github.com/users/gaearon/followers",
    "following_url": "https://api.github.com/users/gaearon/following{/other_user}",
    "gists_url": "https://api.github.com/users/gaearon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gaearon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gaearon/subscriptions",
    "organizations_url": "https://api.github.com/users/gaearon/orgs",
    "repos_url": "https://api.github.com/users/gaearon/repos",
    "events_url": "https://api.github.com/users/gaearon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gaearon/received_events",
    "type": "User",
    "site_admin": false
  }
}
