{
  "url": "https://api.github.com/repos/facebook/react/issues/16508",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/16508/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/16508/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/16508/events",
  "html_url": "https://github.com/facebook/react/issues/16508",
  "id": 482813021,
  "node_id": "MDU6SXNzdWU0ODI4MTMwMjE=",
  "number": 16508,
  "title": "Bug - Upgrading `react-dom` from 16.8.6 to 16.9.0 breaks tests (await Promise.all not supported)",
  "user": {
    "login": "mulholio",
    "id": 20966690,
    "node_id": "MDQ6VXNlcjIwOTY2Njkw",
    "avatar_url": "https://avatars2.githubusercontent.com/u/20966690?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mulholio",
    "html_url": "https://github.com/mulholio",
    "followers_url": "https://api.github.com/users/mulholio/followers",
    "following_url": "https://api.github.com/users/mulholio/following{/other_user}",
    "gists_url": "https://api.github.com/users/mulholio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mulholio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mulholio/subscriptions",
    "organizations_url": "https://api.github.com/users/mulholio/orgs",
    "repos_url": "https://api.github.com/users/mulholio/repos",
    "events_url": "https://api.github.com/users/mulholio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mulholio/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 10,
  "created_at": "2019-08-20T11:49:51Z",
  "updated_at": "2019-08-21T14:27:23Z",
  "closed_at": "2019-08-21T13:24:07Z",
  "author_association": "NONE",
  "body": "When upgrading to react-dom 16.9.0, I have several jest tests break.\r\n\r\nThe first failure is pasted below. There are other failures to do with missing elements on the page (renders in the browser fine) but they feel less informative so are being omitted for now.\r\n\r\n**What is the expected behavior?**\r\nTests pass!\r\n\r\nI'm unsure of whether this is a bug with react or whether it's just something else that this upgrade has revealed. Could also be an issue with something else in the test setup (my code, React Testing Library, Jest, babel compilation)\r\n\r\nI also suspect there might be something wrong with my usage of the async loading of polyfills in `componentDidMount` but I'm not sure if this is the case. If this is the case it would still mean that other tests were breaking in the upgrade.\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\nOnly occurs with 16.9.0. Was working with 16.8.6\r\n\r\n### Failing Test Message\r\n``` \r\n● <CustomApp /> › renders the error page with a 500 error if there is an unknown error\r\n\r\n    Not supported\r\n\r\n      26 | async function loadIntlPolyfills(locale: string) {\r\n      27 |   const lang = localeToLang(locale);\r\n    > 28 |   await Promise.all([\r\n         |                 ^\r\n      29 |     import('intl-pluralrules'),\r\n      30 |     import('@formatjs/intl-relativetimeformat/polyfill'),\r\n      31 |     import(`@formatjs/intl-relativetimeformat/dist/locale-data/${lang}`),\r\n\r\n      at all (pages/_app.tsx:28:17)\r\n      at CustomApp.loadIntlPolyfills (pages/_app.tsx:153:5)\r\n      at commitLifeCycles (node_modules/react-dom/cjs/react-dom.development.js:20049:22)\r\n      at commitLayoutEffects (node_modules/react-dom/cjs/react-dom.development.js:22813:7)\r\n      at HTMLUnknownElement.callCallback (node_modules/react-dom/cjs/react-dom.development.js:347:14)\r\n      at invokeEventListeners (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:193:27)\r\n      at HTMLUnknownElementImpl._dispatch (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:119:9)\r\n      at HTMLUnknownElementImpl.dispatchEvent (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:82:17)\r\n      at HTMLUnknownElementImpl.dispatchEvent (node_modules/jsdom/lib/jsdom/living/nodes/HTMLElement-impl.js:30:27)\r\n      at HTMLUnknownElement.dispatchEvent (node_modules/jsdom/lib/jsdom/living/generated/EventTarget.js:157:21)\r\n      at Object.invokeGuardedCallbackDev (node_modules/react-dom/cjs/react-dom.development.js:397:16)\r\n      at invokeGuardedCallback (node_modules/react-dom/cjs/react-dom.development.js:454:31)\r\n      at commitRootImpl (node_modules/react-dom/cjs/react-dom.development.js:22585:9)\r\n      at unstable_runWithPriority (node_modules/scheduler/cjs/scheduler.development.js:643:12)\r\n      at runWithPriority$2 (node_modules/react-dom/cjs/react-dom.development.js:11305:10)\r\n      at commitRoot (node_modules/react-dom/cjs/react-dom.development.js:22414:3)\r\n      at scheduleUpdateOnFiber (node_modules/react-dom/cjs/react-dom.development.js:21421:20)\r\n      at scheduleRootUpdate (node_modules/react-dom/cjs/react-dom.development.js:24319:3)\r\n      at updateContainerAtExpirationTime (node_modules/react-dom/cjs/react-dom.development.js:24347:10)\r\n      at updateContainer (node_modules/react-dom/cjs/react-dom.development.js:24436:10)\r\n      at node_modules/react-dom/cjs/react-dom.development.js:24963:7\r\n      at unbatchedUpdates (node_modules/react-dom/cjs/react-dom.development.js:21687:12)\r\n      at legacyRenderSubtreeIntoContainer (node_modules/react-dom/cjs/react-dom.development.js:24962:5)\r\n      at Object.render (node_modules/react-dom/cjs/react-dom.development.js:25042:12)\r\n      at node_modules/@testing-library/react/dist/pure.js:86:25\r\n      at batchedUpdates$1 (node_modules/react-dom/cjs/react-dom.development.js:21643:12)\r\n      at act (node_modules/react-dom/cjs/react-dom-test-utils.development.js:1002:14)\r\n      at act (node_modules/react-dom/cjs/react-dom-test-utils.development.js:1418:12)\r\n      at render (node_modules/@testing-library/react/dist/pure.js:82:26)\r\n      at Object.it (__tests__/pages/_app.test.tsx:68:27)\r\n```\r\n\r\n### Custom `_app.tsx` (Next component, see docs [here](https://nextjs.org/docs#custom-app))\r\n```typescript\r\n// _app.tsx\r\n\r\nasync function loadIntlPolyfills(locale: string) {\r\n  const lang = localeToLang(locale);\r\n  await Promise.all([\r\n    import('intl-pluralrules'),\r\n    import('@formatjs/intl-relativetimeformat/polyfill'),\r\n    import(`@formatjs/intl-relativetimeformat/dist/locale-data/${lang}`),\r\n  ]);\r\n}\r\n\r\nexport default class CustomApp extends App<Props, State> {\r\n  // ...\r\n\r\n  componentDidMount(): void {\r\n    const { locale } = this.props;\r\n    loadIntlPolyfills(locale);\r\n    // ...\r\n  }\r\n\r\n  // ...\r\n}\r\n```\r\n\r\n### Failing Test\r\n```typescript\r\n  let mockedRouter;\r\n\r\n  it('renders the error page with a 500 error if there is an unknown error', async () => {\r\n    const props = await CustomApp.getInitialProps({\r\n      Component: TestComponent, // some mocked component with getInitialProps\r\n      ctx: {\r\n        req: reqMock,\r\n      },\r\n    });\r\n\r\n    mockedRouter = { pathname: '/web-client-test/' };\r\n    Router.router = mockedRouter;\r\n    jest.spyOn(global.console, 'error').mockImplementation(() => {});\r\n    const pageProps = {\r\n      throwWebErrorInInitialProps: false,\r\n      throwWebErrorInRender: false,\r\n    };\r\n\r\n    const app = (\r\n      <CustomApp\r\n        {...props}\r\n        Component={TestComponent}\r\n        router={Router.router}\r\n        pageProps={pageProps}\r\n      />\r\n    );\r\n\r\n    const { getByText } = rtlRender(app);\r\n    expect(\r\n      getByText('A 500 error occurred on the server.'),\r\n    ).toBeInTheDocument();\r\n  });\r\n\r\n```\r\n\r\n### Complete diff between version of our app that had passing tests and version with failing tests\r\n(apologies for b&w diff; `+`s and `-`s should show changes)\r\n```\r\ndiff --git a/web_client/package.json b/web_client/package.json\r\nindex e8f0aebdf3..bdb47345fa 100644\r\n--- a/web_client/package.json\r\n+++ b/web_client/package.json\r\n@@ -41,7 +41,7 @@\r\n     \"postcss-flexbugs-fixes\": \"^4.1.0\",\r\n     \"query-string\": \"5\",\r\n     \"react\": \"^16.9.0\",\r\n-    \"react-dom\": \"^16.8.6\",\r\n+    \"react-dom\": \"^16.9.0\",\r\n     \"react-intl\": \"^3.1.8\",\r\n     \"react-stripe-elements\": \"^4.0.1\",\r\n     \"store\": \"^2.0.12\",\r\ndiff --git a/web_client/yarn.lock b/web_client/yarn.lock\r\nindex 3658d6ccfc..900e0caa5a 100644\r\n--- a/web_client/yarn.lock\r\n+++ b/web_client/yarn.lock\r\n@@ -7959,15 +7959,15 @@ rc@^1.2.7:\r\n     minimist \"^1.2.0\"\r\n     strip-json-comments \"~2.0.1\"\r\n\r\n-react-dom@^16.8.6:\r\n-  version \"16.8.6\"\r\n-  resolved \"https://registry.yarnpkg.com/react-dom/-/react-dom-16.8.6.tgz#71d6303f631e8b0097f56165ef608f051ff6e10f\"\r\n-  integrity sha512-1nL7PIq9LTL3fthPqwkvr2zY7phIPjYrT0jp4HjyEQrEROnw4dG41VVwi/wfoCneoleqrNX7iAD+pXebJZwrwA==\r\n+react-dom@^16.9.0:\r\n+  version \"16.9.0\"\r\n+  resolved \"https://registry.yarnpkg.com/react-dom/-/react-dom-16.9.0.tgz#5e65527a5e26f22ae3701131bcccaee9fb0d3962\"\r\n+  integrity sha512-YFT2rxO9hM70ewk9jq0y6sQk8cL02xm4+IzYBz75CQGlClQQ1Bxq0nhHF6OtSbit+AIahujJgb/CPRibFkMNJQ==\r\n   dependencies:\r\n     loose-envify \"^1.1.0\"\r\n     object-assign \"^4.1.1\"\r\n     prop-types \"^15.6.2\"\r\n-    scheduler \"^0.13.6\"\r\n+    scheduler \"^0.15.0\"\r\n\r\n react-error-overlay@5.1.6:\r\n   version \"5.1.6\"\r\n@@ -8505,10 +8505,10 @@ sax@^1.2.4, sax@~1.2.1:\r\n   resolved \"https://registry.yarnpkg.com/sax/-/sax-1.2.4.tgz#2816234e2378bddc4e5354fab5caa895df7100d9\"\r\n   integrity sha512-NqVDv9TpANUjFm0N8uM5GxL36UgKi9/atZw+x7YFnQ8ckwFGKrl4xX4yWtrey3UJm5nP1kUbnYgLopqWNSRhWw==\r\n\r\n-scheduler@^0.13.6:\r\n-  version \"0.13.6\"\r\n-  resolved \"https://registry.yarnpkg.com/scheduler/-/scheduler-0.13.6.tgz#466a4ec332467b31a91b9bf74e5347072e4cd889\"\r\n-  integrity sha512-IWnObHt413ucAYKsD9J1QShUKkbKLQQHdxRyw73sw4FN26iWr3DY/H34xGPe4nmL1DwXyWmSWmMrA9TfQbE/XQ==\r\n+scheduler@^0.15.0:\r\n+  version \"0.15.0\"\r\n+  resolved \"https://registry.yarnpkg.com/scheduler/-/scheduler-0.15.0.tgz#6bfcf80ff850b280fed4aeecc6513bc0b4f17f8e\"\r\n+  integrity sha512-xAefmSfN6jqAa7Kuq7LIJY0bwAPG3xlCj0HMEBQk1lxYiDKZscY2xJ5U/61ZTrYbmNQbXa+gc7czPkVo11tnCg==\r\n   dependencies:\r\n     loose-envify \"^1.1.0\"\r\n     object-assign \"^4.1.1\"\r\n(END)\r\n```",
  "closed_by": {
    "login": "threepointone",
    "id": 18808,
    "node_id": "MDQ6VXNlcjE4ODA4",
    "avatar_url": "https://avatars2.githubusercontent.com/u/18808?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/threepointone",
    "html_url": "https://github.com/threepointone",
    "followers_url": "https://api.github.com/users/threepointone/followers",
    "following_url": "https://api.github.com/users/threepointone/following{/other_user}",
    "gists_url": "https://api.github.com/users/threepointone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/threepointone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/threepointone/subscriptions",
    "organizations_url": "https://api.github.com/users/threepointone/orgs",
    "repos_url": "https://api.github.com/users/threepointone/repos",
    "events_url": "https://api.github.com/users/threepointone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/threepointone/received_events",
    "type": "User",
    "site_admin": false
  }
}
