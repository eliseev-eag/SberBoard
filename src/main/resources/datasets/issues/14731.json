{
  "url": "https://api.github.com/repos/facebook/react/issues/14731",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/14731/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/14731/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/14731/events",
  "html_url": "https://github.com/facebook/react/issues/14731",
  "id": 404909548,
  "node_id": "MDU6SXNzdWU0MDQ5MDk1NDg=",
  "number": 14731,
  "title": "useState inside a context provider not properly read when called from timeout",
  "user": {
    "login": "gregoryjjb",
    "id": 7061296,
    "node_id": "MDQ6VXNlcjcwNjEyOTY=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/7061296?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gregoryjjb",
    "html_url": "https://github.com/gregoryjjb",
    "followers_url": "https://api.github.com/users/gregoryjjb/followers",
    "following_url": "https://api.github.com/users/gregoryjjb/following{/other_user}",
    "gists_url": "https://api.github.com/users/gregoryjjb/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gregoryjjb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gregoryjjb/subscriptions",
    "organizations_url": "https://api.github.com/users/gregoryjjb/orgs",
    "repos_url": "https://api.github.com/users/gregoryjjb/repos",
    "events_url": "https://api.github.com/users/gregoryjjb/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gregoryjjb/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2019-01-30T18:43:08Z",
  "updated_at": "2019-01-30T19:26:36Z",
  "closed_at": "2019-01-30T19:26:36Z",
  "author_association": "NONE",
  "body": "<!--\r\n  Note: if the issue is about documentation or the website, please file it at:\r\n  https://github.com/reactjs/reactjs.org/issues/new\r\n-->\r\n\r\n**Do you want to request a *feature* or report a *bug*?**\r\n\r\nLooks like a **bug**.\r\n\r\n**What is the current behavior?**\r\n\r\nI have a simple context set up to manage a global store. When implementing this context as a functional component with the useState hook, calls to my setStore function from inside a timeout are seeing old versions of the store and updating it incorrectly.\r\n\r\nPossibly a duplicate of #14010 but I don't see why the value of my store should be getting saved by the closure. The closure created by the setTimeout can't see the value of store, so it shouldn't be captured.\r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce and if possible a minimal demo of the problem. Your bug will get fixed much faster if we can run your code and it doesn't have dependencies other than React. Paste the link to your JSFiddle (https://jsfiddle.net/Luktwrdm/) or CodeSandbox (https://codesandbox.io/s/new) example below:**\r\n\r\n[https://codesandbox.io/s/mnxr754oy](https://codesandbox.io/s/mnxr754oy)\r\n\r\nRefresh the page in the sandbox and click the \"Increment otherVal\" button a few times. After 3 seconds, a timeout fires in ChildThree that sets myVal to 42 but doesn't touch otherVal; however, the changes made by incrementing otherVal get blown away. This doesn't happen with changes prompted by onClick events (as you can test by clicking \"Set myVal to 42\" on the bottom), only timeouts.\r\n\r\nThe context implementation is in `store.js`. If you swap out the functional StoreProvider with the commented out class version, everything works as expected.\r\n\r\nIt's possible that I'm doing something wrong with how my closures are being created in the functional StoreProvider but I can't see why.\r\n\r\n**What is the expected behavior?**\r\n\r\nThe context provided function setStore should be seeing the correct copy of the state returned by the hook.\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\n\r\nTested in Chrome/Firefox/Edge on React 16.9.0-alpha.1",
  "closed_by": {
    "login": "gregoryjjb",
    "id": 7061296,
    "node_id": "MDQ6VXNlcjcwNjEyOTY=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/7061296?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gregoryjjb",
    "html_url": "https://github.com/gregoryjjb",
    "followers_url": "https://api.github.com/users/gregoryjjb/followers",
    "following_url": "https://api.github.com/users/gregoryjjb/following{/other_user}",
    "gists_url": "https://api.github.com/users/gregoryjjb/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gregoryjjb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gregoryjjb/subscriptions",
    "organizations_url": "https://api.github.com/users/gregoryjjb/orgs",
    "repos_url": "https://api.github.com/users/gregoryjjb/repos",
    "events_url": "https://api.github.com/users/gregoryjjb/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gregoryjjb/received_events",
    "type": "User",
    "site_admin": false
  }
}
