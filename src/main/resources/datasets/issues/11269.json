{
  "url": "https://api.github.com/repos/facebook/react/issues/11269",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/11269/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/11269/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/11269/events",
  "html_url": "https://github.com/facebook/react/pull/11269",
  "id": 266561244,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTQ3MzUyMDEw",
  "number": 11269,
  "title": "Add static injection for feature flags",
  "user": {
    "login": "gaearon",
    "id": 810438,
    "node_id": "MDQ6VXNlcjgxMDQzOA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/810438?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gaearon",
    "html_url": "https://github.com/gaearon",
    "followers_url": "https://api.github.com/users/gaearon/followers",
    "following_url": "https://api.github.com/users/gaearon/following{/other_user}",
    "gists_url": "https://api.github.com/users/gaearon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gaearon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gaearon/subscriptions",
    "organizations_url": "https://api.github.com/users/gaearon/orgs",
    "repos_url": "https://api.github.com/users/gaearon/repos",
    "events_url": "https://api.github.com/users/gaearon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gaearon/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 196858374,
      "node_id": "MDU6TGFiZWwxOTY4NTgzNzQ=",
      "url": "https://api.github.com/repos/facebook/react/labels/CLA%20Signed",
      "name": "CLA Signed",
      "color": "e7e7e7",
      "default": false
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2017-10-18T16:39:30Z",
  "updated_at": "2017-10-18T17:44:23Z",
  "closed_at": "2017-10-18T17:40:53Z",
  "author_association": "MEMBER",
  "pull_request": {
    "url": "https://api.github.com/repos/facebook/react/pulls/11269",
    "html_url": "https://github.com/facebook/react/pull/11269",
    "diff_url": "https://github.com/facebook/react/pull/11269.diff",
    "patch_url": "https://github.com/facebook/react/pull/11269.patch"
  },
  "body": "Related to discussion in https://github.com/facebook/react/pull/11260.\r\n\r\nThis does two things:\r\n\r\n* Removes `ReactDOMFeatureFlags` as a separate entity, instead opting for unified feature flag list across the whole codebase in `ReactFeatureFlags`.\r\n\r\n* Adds a mechanism to specify build-time overrides for the whole `ReactFeatureFlags` file for a particular bundle.\r\n\r\nFor example, let’s say we have a flag called `includePersistenceImplementation`, and `react-native-cs` wants to flip it to `true`. To introduce it, we would need to:\r\n\r\n1) Add it to `ReactFeatureFlags.js`:\r\n\r\n```diff\r\nexport type FeatureFlags = {|\r\n  enableAsyncSubtreeAPI: boolean,\r\n  enableAsyncSchedulingByDefaultInReactDOM: boolean,\r\n+  includePersistenceImplementation: boolean\r\n|};\r\n\r\nvar ReactFeatureFlags: FeatureFlags = {\r\n  enableAsyncSubtreeAPI: true,\r\n  enableAsyncSchedulingByDefaultInReactDOM: false,\r\n+ includePersistenceImplementation: false,\r\n};\r\n```\r\n\r\n2) Add new `ReactNativeCSFeatureFlags.js`:\r\n\r\n```js\r\nimport type {FeatureFlags} from 'ReactFeatureFlags';\r\n\r\nconst ReactNativeCSFeatureFlags: FeatureFlags = {\r\n  enableAsyncSubtreeAPI: true,\r\n  enableAsyncSchedulingByDefaultInReactDOM: false,\r\n  includePersistenceImplementation: true, // <---- the important part\r\n};\r\n\r\nmodule.exports = ReactNativeCSFeatureFlags;\r\n```\r\n\r\nNote how it has to include *all* flags since we’re fully forking the file. It might seem a bit annoying but it’s simpler than figuring out how to merge them both at compile, Flow, and test time. Exact Flow types here guard us against mistakes.\r\n\r\n3) Use it in the build config:\r\n\r\n```diff\r\n    name: 'react-native-cs-renderer',\r\n+   featureFlags: 'src/renderers/native-cs/ReactNativeCSFeatureFlags',\r\n    paths: [\r\n      'src/renderers/native-cs/**/*.js',\r\n      'src/renderers/shared/**/*.js',\r\n```\r\n\r\nWe can remove this step and make it conventional after https://github.com/facebook/react/pull/11252.\r\n\r\n4) Use it in tests when necessary:\r\n\r\n```js\r\njest.mock('ReactFeatureFlags', () => require('ReactNativeCSFeatureFlags'));\r\n```\r\n\r\nThis should be enough to enable DCE for cases like https://github.com/facebook/react/pull/11260 because GCC (which we use for `react-dom`) is smart enough to read static boolean flags.\r\n\r\nPotential pitfalls of this approach:\r\n\r\n* Might not be obvious `ReactFeatureFlags` needs to be mocked in tests.\r\n* Might not be obvious flags need to be specified in all overrides, rather than merged.\r\n\r\nPotential future work:\r\n\r\n* Remove the configuration bit and locate per-package `FeatureFlags` override automatically.\r\n* Generalize this as a static injection system for overriding any modules.\r\n* Maybe split out into `ReactBuildFlags` and `ReactRuntimeFlags` for extra clarity?",
  "closed_by": {
    "login": "gaearon",
    "id": 810438,
    "node_id": "MDQ6VXNlcjgxMDQzOA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/810438?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gaearon",
    "html_url": "https://github.com/gaearon",
    "followers_url": "https://api.github.com/users/gaearon/followers",
    "following_url": "https://api.github.com/users/gaearon/following{/other_user}",
    "gists_url": "https://api.github.com/users/gaearon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gaearon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gaearon/subscriptions",
    "organizations_url": "https://api.github.com/users/gaearon/orgs",
    "repos_url": "https://api.github.com/users/gaearon/repos",
    "events_url": "https://api.github.com/users/gaearon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gaearon/received_events",
    "type": "User",
    "site_admin": false
  }
}
