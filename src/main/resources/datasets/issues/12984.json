{
  "url": "https://api.github.com/repos/facebook/react/issues/12984",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/12984/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/12984/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/12984/events",
  "html_url": "https://github.com/facebook/react/issues/12984",
  "id": 329623014,
  "node_id": "MDU6SXNzdWUzMjk2MjMwMTQ=",
  "number": 12984,
  "title": "nested contexts don't unwind correctly when server side rendering",
  "user": {
    "login": "ericsoderberghp",
    "id": 11637956,
    "node_id": "MDQ6VXNlcjExNjM3OTU2",
    "avatar_url": "https://avatars0.githubusercontent.com/u/11637956?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ericsoderberghp",
    "html_url": "https://github.com/ericsoderberghp",
    "followers_url": "https://api.github.com/users/ericsoderberghp/followers",
    "following_url": "https://api.github.com/users/ericsoderberghp/following{/other_user}",
    "gists_url": "https://api.github.com/users/ericsoderberghp/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ericsoderberghp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ericsoderberghp/subscriptions",
    "organizations_url": "https://api.github.com/users/ericsoderberghp/orgs",
    "repos_url": "https://api.github.com/users/ericsoderberghp/repos",
    "events_url": "https://api.github.com/users/ericsoderberghp/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ericsoderberghp/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2018-06-05T21:00:28Z",
  "updated_at": "2018-06-13T16:58:20Z",
  "closed_at": "2018-06-05T22:45:46Z",
  "author_association": "CONTRIBUTOR",
  "body": "**Do you want to request a *feature* or report a *bug*?**\r\n\r\nbug\r\n\r\n**What is the current behavior?**\r\n\r\nWhen different contexts are nested, as in they have different types, they do not unwind correctly when rendering via `renderToString()`.\r\n\r\nHere is a snippet that demonstrates the issue:\r\n\r\n```\r\nimport React from 'react';\r\nimport { renderToString } from 'react-dom/server';\r\n\r\nconst valueA = { letter: 'A' };\r\nconst valueB = { letter: 'B' };\r\nconst LetterContext = React.createContext(valueA);\r\nconst NumberContext = React.createContext(undefined);\r\n\r\nconst html = renderToString((\r\n  <LetterContext.Provider value={valueA}>\r\n    <NumberContext.Provider>\r\n      <LetterContext.Consumer>\r\n        {letterValue => (\r\n          <div>\r\n            {letterValue.letter}\r\n            <LetterContext.Provider value={valueB}>\r\n              <LetterContext.Consumer>\r\n                {innerValue => <div>{innerValue.letter}</div>}\r\n              </LetterContext.Consumer>\r\n            </LetterContext.Provider>\r\n          </div>\r\n        )}\r\n      </LetterContext.Consumer>\r\n      <LetterContext.Consumer>\r\n        {value => <div>{value.letter}</div>}\r\n      </LetterContext.Consumer>\r\n    </NumberContext.Provider>\r\n  </LetterContext.Provider>\r\n));\r\n\r\nconsole.log(html);\r\n```\r\n\r\nThis results in:\r\n\r\n```\r\n          value.letter\r\n                ^\r\n\r\nTypeError: Cannot read property 'letter' of undefined\r\n    at Object.children (/Users/ericsoderberg/Documents/git/grommet2/grommet-icons-site/tools/example.js:25:31)\r\n    at ReactDOMServerRenderer.render (/Users/ericsoderberg/Documents/git/grommet2/grommet-icons-site/node_modules/react-dom/cjs/react-dom-server.node.development.js:2462:55)\r\n    at ReactDOMServerRenderer.read (/Users/ericsoderberg/Documents/git/grommet2/grommet-icons-site/node_modules/react-dom/cjs/react-dom-server.node.development.js:2325:19)\r\n    at renderToString (/Users/ericsoderberg/Documents/git/grommet2/grommet-icons-site/node_modules/react-dom/cjs/react-dom-server.node.development.js:2697:25)\r\n    at Object.<anonymous> (/Users/ericsoderberg/Documents/git/grommet2/grommet-icons-site/tools/example.js:9:14)\r\n    at Module._compile (internal/modules/cjs/loader.js:678:30)\r\n    at loader (/Users/ericsoderberg/Documents/git/grommet2/grommet-icons-site/node_modules/babel-register/lib/node.js:144:5)\r\n    at Object.require.extensions.(anonymous function) [as .js] (/Users/ericsoderberg/Documents/git/grommet2/grommet-icons-site/node_modules/babel-register/lib/node.js:154:7)\r\n    at Module.load (internal/modules/cjs/loader.js:589:32)\r\n    at tryModuleLoad (internal/modules/cjs/loader.js:528:12)\r\n```\r\n\r\n**What is the expected behavior?**\r\n\r\nWhen context providers are nested, they should correctly unwind such that the contexts return the correct value at each level. No exception should be generated and the output should be:\r\n\r\n`<div>A<div>B</div></div><div>A</div>`\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\n\r\nThis was uncovered using version 16.4.0 of `react-dom` on OSX using node v10.1.0.\r\n\r\nThis only shows up when using `renderToString()`. It works as expected in the browser.\r\n\r\n** Note **\r\n\r\nI wonder if this might be due to the following snippet of `react-dom-server.node.development.js`. Where the previous provider added to the stack is assumed to have the same type as the provider being popped.\r\n\r\n```\r\n    var context = provider.type._context;\r\n    if (this.providerIndex < 0) {\r\n      context._currentValue = context._defaultValue;\r\n    } else {\r\n      // We assume this type is correct because of the index check above.\r\n      var previousProvider = this.providerStack[this.providerIndex];\r\n      context._currentValue = previousProvider.props.value;\r\n    }\r\n```\r\n\r\nI am investigating further and hope to provide a pull request soon.\r\n",
  "closed_by": {
    "login": "aweary",
    "id": 6886061,
    "node_id": "MDQ6VXNlcjY4ODYwNjE=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/6886061?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/aweary",
    "html_url": "https://github.com/aweary",
    "followers_url": "https://api.github.com/users/aweary/followers",
    "following_url": "https://api.github.com/users/aweary/following{/other_user}",
    "gists_url": "https://api.github.com/users/aweary/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/aweary/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aweary/subscriptions",
    "organizations_url": "https://api.github.com/users/aweary/orgs",
    "repos_url": "https://api.github.com/users/aweary/repos",
    "events_url": "https://api.github.com/users/aweary/events{/privacy}",
    "received_events_url": "https://api.github.com/users/aweary/received_events",
    "type": "User",
    "site_admin": false
  }
}
