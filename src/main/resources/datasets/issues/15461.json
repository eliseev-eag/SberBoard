{
  "url": "https://api.github.com/repos/facebook/react/issues/15461",
  "repository_url": "https://api.github.com/repos/facebook/react",
  "labels_url": "https://api.github.com/repos/facebook/react/issues/15461/labels{/name}",
  "comments_url": "https://api.github.com/repos/facebook/react/issues/15461/comments",
  "events_url": "https://api.github.com/repos/facebook/react/issues/15461/events",
  "html_url": "https://github.com/facebook/react/issues/15461",
  "id": 435393033,
  "node_id": "MDU6SXNzdWU0MzUzOTMwMzM=",
  "number": 15461,
  "title": "Issue with useEffect cleanup during react-dom re-render and HMR",
  "user": {
    "login": "swashata",
    "id": 1623381,
    "node_id": "MDQ6VXNlcjE2MjMzODE=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/1623381?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/swashata",
    "html_url": "https://github.com/swashata",
    "followers_url": "https://api.github.com/users/swashata/followers",
    "following_url": "https://api.github.com/users/swashata/following{/other_user}",
    "gists_url": "https://api.github.com/users/swashata/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/swashata/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/swashata/subscriptions",
    "organizations_url": "https://api.github.com/users/swashata/orgs",
    "repos_url": "https://api.github.com/users/swashata/repos",
    "events_url": "https://api.github.com/users/swashata/events{/privacy}",
    "received_events_url": "https://api.github.com/users/swashata/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2019-04-20T12:24:52Z",
  "updated_at": "2019-04-22T05:28:50Z",
  "closed_at": null,
  "author_association": "NONE",
  "body": "<!--\r\n  Note: if the issue is about documentation or the website, please file it at:\r\n  https://github.com/reactjs/reactjs.org/issues/new\r\n-->\r\n\r\n**Do you want to request a *feature* or report a *bug*?**\r\n\r\nA bug (I suppose).\r\n\r\n**What is the current behavior?**\r\n\r\nI think, the cleanup of `useEffect` isn't firing at proper time when doing a HMR update like this\r\n\r\n```js\r\nimport React from 'react';\r\nimport ReactDOM from 'react-dom';\r\n\r\nimport App from './App';\r\n\r\nconst mountNode = document.querySelector('#root');\r\nReactDOM.render(<App />, mountNode);\r\n\r\nif (module.hot) {\r\n\tmodule.hot.accept('./App.tsx', () => {\r\n\t\tconst NewApp = require('./App.js').default;\r\n\t\tReactDOM.render(<NewApp />, mountNode);\r\n\t});\r\n}\r\n```\r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce and if possible a minimal demo of the problem.**\r\n\r\nTo reproduce the issue, please clone this repository https://github.com/swashata/react-issue-hmr-useeffect and run `yarn start`.\r\n\r\nFirst change the counter from the application and the document title will update to something like `(1) React App`.\r\n\r\nThen change the `src/Counter.js` file and see that document title being changed to `(0) (1) React App`.\r\n\r\nThe code with useEffect is like this\r\n\r\n```js\r\n  // const [count, setCount] = useState(0);\r\n  const [state, dispatch] = useReducer(counterReducer, { count: 0 });\r\n  const { count } = state;\r\n  // get initial document.title and persist it\r\n  // based on initial title, so we use useRef\r\n  const initialDocTitle = useRef(document.title);\r\n\r\n  // change document title if count changes\r\n  useEffect(() => {\r\n    const docTitle = initialDocTitle.current;\r\n    document.title = `(${count}) ${docTitle}`;\r\n    return () => {\r\n      document.title = docTitle;\r\n    };\r\n  }, [count]);\r\n```\r\n\r\nHere's a gif demonstrating the issue\r\n\r\n![react-issue-gif](https://user-images.githubusercontent.com/1623381/56457197-bc7b0800-6394-11e9-9aa7-6396702bdeda.gif)\r\n\r\n(**YouTube [link](https://youtu.be/vjG8o6EmlMU)**)\r\n\r\nStrangely enough, it works with codesandbox: https://codesandbox.io/s/q0m6wjklw\r\n\r\n**What is the expected behavior?**\r\n\r\nI am not sure, but I guess, if ReactDOM renders something on top, the `useEffect` cleanups from the previous render should fire first?\r\n\r\n**Which versions of React, and which browser / OS are affected by this issue? Did this work in previous versions of React?**\r\n\r\n\r\n```json\r\n{\r\n  \"dependencies\": {\r\n    \"react\": \"^16.8.6\",\r\n    \"react-dom\": \"^16.8.6\",\r\n    \"react-scripts\": \"2.1.8\"\r\n  }\r\n}\r\n```\r\n\r\n* **Browser**: Chrome Version 73.0.3683.103\r\n* **OS**: macOS 10.14.4\r\n\r\n",
  "closed_by": null
}
